<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="å·å°æ¡¥ | æ— æ­¢ - æ ¡å›­æ— éšœç¢ç¯å¢ƒç›‘æµ‹ä¸äº’åŠ©åœ°å›¾ç³»ç»Ÿ ">
    <meta name="theme-color" content="#3b82f6">
    <title>å·å°æ¡¥ | æ— æ­¢ -</title>
    
    <!-- ==================================================================================
         1. æ ¸å¿ƒä¾èµ–åº“ (CDN)
         ================================================================================== -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- ==================================================================================
         2. å…¨å±€æ ·å¼å®šä¹‰ (CSS)
         ================================================================================== -->
    <style>
        body, html, #root { 
            margin: 0; padding: 0; height: 100%; height: 100dvh; width: 100%; overflow: hidden; 
            font-family: system-ui, -apple-system, sans-serif; 
            -webkit-tap-highlight-color: transparent; background-color: #f8fafc; touch-action: manipulation; 
        }
        
        #map-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; background: #e2e8f0; transition: filter 0.3s ease; }
        .ui-layer { position: absolute; inset: 0; z-index: 1000; pointer-events: none; overflow: hidden; display: flex; flex-direction: column; }
        .pointer-events-auto { pointer-events: auto; }

        /* --- åŠ¨ç”» --- */
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes gauge { from { width: 0%; } }

        .anim-scale-in { animation: scaleIn 0.2s ease-out; }
        .anim-slide-up { animation: slideInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .anim-fade-in { animation: fadeIn 0.2s ease-out; }
        .mic-active { animation: pulse-red 1.5s infinite; }
        .gauge-anim { animation: gauge 1s ease-out forwards; }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500; opacity: 0; transition: opacity 0.3s; pointer-events: none; backdrop-filter: blur(2px); }
        .sidebar-backdrop.active { opacity: 1; pointer-events: auto; }
        .sidebar-panel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s; box-shadow: 4px 0 24px rgba(0,0,0,0.15); z-index: 2000; }

        /* --- åº•éƒ¨é¢æ¿ --- */
        .bottom-sheet { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(105%); box-shadow: 0 -4px 20px rgba(0,0,0,0.15); }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 4px; background: #cbd5e1; border-radius: 2px; margin: 8px auto; }

        /* --- æ ‡è®°æ ·å¼ --- */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin { width: 30px; height: 30px; border-radius: 50% 50% 50% 0; background: #3b82f6; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px; box-shadow: 0 3px 5px rgba(0,0,0,0.3); border: 2px solid #FFFFFF; display: flex; align-items: center; justify-content: center; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .marker-pin i { transform: rotate(45deg); font-style: normal; color: white; font-weight: 800; font-size: 14px; line-height: 1; }
        .marker-obstacle { background: #ef4444; } .marker-facility { background: #22c55e; } .marker-experience { background: #3b82f6; } .marker-fixed { background: #64748b !important; border-color: #e2e8f0 !important; }
        .marker-selected { transform: rotate(-45deg) scale(1.4) !important; border-color: #fbbf24 !important; z-index: 999 !important; opacity: 1 !important; filter: none !important; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.5); }
        
        /* --- [å‡çº§] ç²¾ç¡®æ ‡è®°å…‰æ ‡ --- */
        /* ä½¿ç”¨ Data URI åˆ›å»ºä¸€ä¸ªçº¢è‰²çš„åå­—å‡†æ˜Ÿå›¾æ ‡ä½œä¸ºå…‰æ ‡ */
        .cursor-target {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="none" stroke="%23ef4444" stroke-width="2"/><line x1="16" y1="0" x2="16" y2="32" stroke="%23ef4444" stroke-width="2"/><line x1="0" y1="16" x2="32" y2="16" stroke="%23ef4444" stroke-width="2"/><circle cx="16" cy="16" r="4" fill="%23ef4444"/></svg>') 16 16, crosshair !important;
        }

        .route-tooltip { background: rgba(255,255,255,0.95); border: 1px solid #cbd5e1; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-weight: bold; font-size: 12px; color: #334155; border-radius: 6px; padding: 4px 8px; }
        .scanning-bar { position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, transparent, #3b82f6, transparent); animation: scan 1.5s infinite; z-index: 5000; display: none; }
        .scanning .scanning-bar { display: block; }
        .high-contrast { filter: contrast(130%); }
        .high-contrast .bg-white { background-color: #000 !important; color: #fff !important; border: 1px solid #fff !important; }
        .high-contrast .text-slate-600, .high-contrast .text-slate-500 { color: #e2e8f0 !important; }
        .high-contrast .bg-slate-50, .high-contrast .bg-slate-100 { background-color: #1e293b !important; color: #fff !important; }
        .fab-btn { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .fab-btn:active { transform: scale(0.9); }
        .toggle-sidebar-btn { transition: all 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toggle-sidebar-btn:active { transform: scale(0.9); }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const safeRender = (val) => (val === null || val === undefined || typeof val === 'object') ? '' : String(val);

        // ----------------------------------------------------------------------------
        // 2. é…ç½® (STRICTLY PRESERVED)
        // ----------------------------------------------------------------------------
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCcBlaYfmLizo1E6mV87U6ytReqSuMTX5M",
             authDomain: "scuwzq-9bcfb.firebaseapp.com",
             projectId: "scuwzq-9bcfb",
             storageBucket: "scuwzq-9bcfb.firebasestorage.app",
             messagingSenderId: "1028374721634",
             appId: "1:1028374721634:web:30714cb0acb6a951590d3b" 
        };

        const GEMINI_API_KEY = ""; 
        const AI_ENDPOINT_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

        const TILE_LAYERS = {
            standard: { name: "æ ‡å‡†", url: "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", attribution: '&copy; CARTO' },
            satellite: { name: "å«æ˜Ÿ", url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", attribution: '&copy; Esri' },
            simple: { name: "æç®€", url: "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", attribution: '&copy; CARTO' }
        };

        const OBSTACLE_CATEGORIES = [
            { value: 'stairs', label: 'å°é˜¶/é«˜å·®' }, { value: 'slope', label: 'å¡åº¦è¿‡é™¡' }, { value: 'surface', label: 'è·¯é¢ä¸å¹³/å‘æ´¼' },
            { value: 'width', label: 'é€šé“è¿‡çª„' }, { value: 'blocked', label: 'ç›²é“è¢«å ç”¨/é˜»æ–­' }, { value: 'other', label: 'å…¶ä»–é—®é¢˜' },
        ];

        const MAP_ELEMENTS = {
            buildings: { name: "å»ºç­‘", layer: 'building', icon: 'Building', query: `way["building"]` },
            roads: { name: "é“è·¯", layer: 'road', icon: 'Road', query: `way["highway"]` },
            water: { name: "æ°´ç³»", layer: 'water', icon: 'Droplet', query: `relation["natural"="water"]; way["natural"="water"]` },
            plants: { name: "æ™¯è§‚/ç»¿æ¤", layer: 'green', icon: 'TreePine', query: `way["leisure"="park"]; way["landuse"="grass"]` }
        };

        const INITIAL_LOCATIONS = [
            { name: "æ±Ÿå®‰æ ¡åŒº", coords: [30.556, 103.998], type: 'point' },
            { name: "æœ›æ±Ÿæ ¡åŒº", coords: [30.631, 104.085], type: 'point' },
            { name: "åè¥¿æ ¡åŒº", coords: [30.622, 104.068], type: 'point' }
        ];

        // ----------------------------------------------------------------------------
        // 3. åˆå§‹åŒ– Firebase
        // ----------------------------------------------------------------------------
        let db = null; let auth = null; let isOfflineMode = true;
        if (FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey.length > 5) {
            try {
                if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth(); db = firebase.firestore();
                db.enablePersistence().catch(e=>{}); isOfflineMode = false;
                console.log("ğŸ”¥ Firebase åœ¨çº¿æ¨¡å¼å·²æ¿€æ´»");
            } catch (e) { console.error("Firebase Init Error", e); }
        }

        // ----------------------------------------------------------------------------
        // 4. å›¾æ ‡åº“
        // ----------------------------------------------------------------------------
        const Icons = {
            Menu: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            X: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Navigation: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Search: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Locate: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="22" y1="12" x2="18" y2="12"/><circle cx="12" cy="12" r="7"/></svg>,
            Target: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Plus: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            AlertTriangle: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            CheckCircle: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Users: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Mic: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Camera: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            Upload: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Image: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Zap: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            ThumbsUp: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>,
            Route: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="6" cy="19" r="3"></circle><path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15"></path><circle cx="18" cy="5" r="3"></circle></svg>,
            Square: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Layers: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Eye: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
            Moon: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Activity: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            BarChart2: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
            Download: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trophy: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M8 21h8m-4-9v9m-6.7-6.27a4 4 0 1 1 0-7.73h13.4a4 4 0 1 1 0 7.73z"/></svg>,
            PieChart: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            User: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            MapPin: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            Building: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="5" width="18" height="16" rx="2"/><line x1="6" y1="17" x2="6" y2="10"/><line x1="10" y1="17" x2="10" y2="10"/><line x1="14" y1="17" x2="14" y2="10"/><line x1="18" y1="17" x2="18" y2="10"/></svg>,
            Droplet: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2.69l5.66 5.66c1.15 1.15 1.15 3.02 0 4.17l-5.66 5.66c-1.15 1.15-3.02 1.15-4.17 0l-5.66-5.66c-1.15-1.15-1.15-3.02 0-4.17l5.66-5.66z"/></svg>,
            TreePine: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M7.74 15.68L2 21h20l-5.74-5.32c-1.15-1.15-3.02-1.15-4.17 0z"/><path d="M12 2v10m-3.5 3l3.5-3.5 3.5 3.5"/></svg>,
            Road: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 21l8-17H3m14 0l-8 17h16"/></svg>,
            Minimize: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>,
            Trash: ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Star: ({size=24, fill="none"}) => <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        };

        // ----------------------------------------------------------------------------
        // 5. å·¥å…·ç»„ä»¶
        // ----------------------------------------------------------------------------
        const vibrate = (pattern = 50) => { if (navigator.vibrate) navigator.vibrate(pattern); };
        const generateRandomName = () => 'çƒ­å¿ƒè¡Œè€…_' + Math.floor(Math.random()*1000);
        
        const Toast = ({ message, onClose }) => {
            useEffect(() => { if(message) { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); } }, [message]);
            if (!message) return null;
            return <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800/90 text-white px-5 py-3 rounded-full text-sm font-bold shadow-xl z-[3000] flex items-center gap-2 anim-fade-in backdrop-blur-md border border-slate-700/50"><span>{safeRender(message)}</span></div>;
        };

        const SafeTextarea = ({ initialValue, onSave, placeholder }) => {
            const textareaRef = useRef(null); const timerRef = useRef(null); const [isListening, setIsListening] = useState(false);
            useEffect(() => { if (textareaRef.current) textareaRef.current.value = safeRender(initialValue); }, [initialValue]);
            const handleInput = (e) => { const val = e.target.value; if (timerRef.current) clearTimeout(timerRef.current); timerRef.current = setTimeout(() => onSave(val), 800); };
            const toggleSpeech = () => {
                vibrate(); if (!('webkitSpeechRecognition' in window)) { alert("è¯·ä½¿ç”¨Chromeæµè§ˆå™¨"); return; }
                if (isListening) return;
                const recognition = new window.webkitSpeechRecognition(); recognition.lang = 'zh-CN';
                recognition.onstart = () => setIsListening(true); recognition.onend = () => setIsListening(false);
                recognition.onresult = (e) => { const txt = e.results[0][0].transcript; textareaRef.current.value = (textareaRef.current.value + ' ' + txt).trim(); onSave(textareaRef.current.value); };
                recognition.start();
            };
            return (
                <div className="relative group">
                    <textarea ref={textareaRef} defaultValue={safeRender(initialValue)} onInput={handleInput} className="w-full border-2 border-slate-200 rounded-xl p-3 h-28 text-sm pr-10 focus:border-blue-400 outline-none" placeholder={placeholder}/>
                    <button onClick={toggleSpeech} className={`absolute bottom-3 right-3 p-2 rounded-full ${isListening ? 'bg-red-500 text-white' : 'text-slate-400 hover:text-blue-500'}`}><Icons.Mic size={18}/></button>
                </div>
            );
        };

        const MapView = React.memo(({ markers, selectedMarkerId, activeTool, onMapClick, onMarkerClick, onMapReady, activeBaseLayer, visibleTypes, currentUserId, customRegions, drawingPoints, currentRoutePoints, customRoutes, onRouteClick, onRegionClick, activeElementFilters }) => {
            const mapRef = useRef(null);
            const layers = useRef({});
            const handlers = useRef({});
            useEffect(() => { handlers.current = { onMapClick, onMarkerClick, onRouteClick, onRegionClick }; }, [onMapClick, onMarkerClick, onRouteClick, onRegionClick]);

            useEffect(() => {
                if (!mapRef.current) {
                    const map = L.map('map-container', { center: INITIAL_LOCATIONS[0].coords, zoom: 16, zoomControl: false, tap: false });
                    layers.current.tile = L.tileLayer(TILE_LAYERS[activeBaseLayer].url, { attribution: '', maxZoom: 20 }).addTo(map);
                    ['element', 'regions', 'routes', 'drawing', 'markers'].forEach(k => layers.current[k] = L.layerGroup().addTo(map));
                    mapRef.current = map;
                    if(onMapReady) onMapReady(map);
                    map.on('click', (e) => { if(handlers.current.onMapClick) handlers.current.onMapClick(e.latlng); });
                }
            }, []);

            useEffect(() => {
                if (mapRef.current && layers.current.tile) {
                    mapRef.current.removeLayer(layers.current.tile);
                    layers.current.tile = L.tileLayer(TILE_LAYERS[activeBaseLayer].url, { attribution: '', maxZoom: 20 }).addTo(mapRef.current);
                }
            }, [activeBaseLayer]);

            // åœ°å›¾è¦ç´ åŠ è½½é€»è¾‘ (Overpass API)
            useEffect(() => {
                if (!layers.current.element) return;
                layers.current.element.clearLayers();
                if (!activeElementFilters) return;
                const config = MAP_ELEMENTS[activeElementFilters];
                if (!config || mapRef.current.getZoom() < 14) return;
                const b = mapRef.current.getBounds();
                const q = `[out:json][timeout:15];(${config.query}(${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}););out geom;`;
                document.body.classList.add('scanning');
                fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: q }).then(r=>r.json()).then(d=>{
                    d.elements.forEach(el => { 
                        if(el.geometry) {
                            const color = activeElementFilters==='water'?'#3b82f6':activeElementFilters==='green'?'#22c55e':'#64748b';
                            L.polyline(el.geometry.map(p=>[p.lat,p.lon]), {color, weight:2, opacity:0.6, interactive:false}).addTo(layers.current.element); 
                        }
                    });
                }).catch(e=>{}).finally(()=>document.body.classList.remove('scanning'));
            }, [activeElementFilters]);

            useEffect(() => {
                if (!layers.current.routes) return;
                layers.current.routes.clearLayers();
                if (customRoutes) customRoutes.forEach(r => {
                    const c = r.type === 'safe' ? '#22c55e' : '#ef4444';
                    const l = L.polyline(r.points, { color: c, weight: 6, opacity: 0.8, className: 'cursor-pointer' }).addTo(layers.current.routes);
                    l.bindTooltip(r.type==='safe'?"æ¨èè·¯çº¿":"å±é™©è·¯æ®µ", {sticky:true, className:'route-tooltip'});
                    l.on('click', (e) => { L.DomEvent.stopPropagation(e); vibrate(); if(handlers.current.onRouteClick) handlers.current.onRouteClick(r); });
                });
            }, [customRoutes]);

            useEffect(() => {
                if (!layers.current.regions) return;
                layers.current.regions.clearLayers();
                if (customRegions) customRegions.forEach(reg => {
                    if(reg.type === 'region' && reg.points) {
                        const p = L.polygon(reg.points, { color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.1, weight: 2 }).addTo(layers.current.regions);
                        p.bindTooltip(reg.name, {permanent: true, direction: 'center', className: 'route-tooltip'});
                        p.on('click', (e) => { L.DomEvent.stopPropagation(e); vibrate(); if(handlers.current.onRegionClick) handlers.current.onRegionClick(reg); });
                    }
                });
            }, [customRegions]);

            // ç»˜å›¾çŠ¶æ€æ¸²æŸ“
            useEffect(() => {
                if (!layers.current.drawing) return;
                layers.current.drawing.clearLayers();
                if (drawingPoints.length) {
                    // æ™¯è§‚ç»˜åˆ¶ä½¿ç”¨ç»¿è‰²ï¼ŒåŒºåŸŸç»˜åˆ¶ä½¿ç”¨è“è‰²
                    const color = activeTool === 'draw-landscape' ? '#22c55e' : '#3b82f6';
                    L.polygon(drawingPoints, { color: color, weight: 2, dashArray: '5, 10' }).addTo(layers.current.drawing);
                    drawingPoints.forEach(p => L.circleMarker(p, { radius: 4, color: color, fillColor: '#fff', fillOpacity: 1 }).addTo(layers.current.drawing));
                }
                if (currentRoutePoints.length) {
                     L.polyline(currentRoutePoints, { color: '#10b981', weight: 4, dashArray: '10, 10' }).addTo(layers.current.drawing);
                     currentRoutePoints.forEach(p => L.circleMarker(p, { radius: 3, color: '#10b981', fillColor: '#fff' }).addTo(layers.current.drawing));
                }
            }, [drawingPoints, currentRoutePoints, activeTool]);

            useEffect(() => {
                if (!layers.current.markers) return;
                layers.current.markers.clearLayers();
                markers.forEach(m => {
                    if (!visibleTypes[m.type]) return;
                    const cls = m.status === 'fixed' ? 'marker-fixed' : (m.type === 'obstacle' ? 'marker-obstacle' : m.type === 'facility' ? 'marker-facility' : 'marker-experience');
                    const sel = selectedMarkerId === m.id ? 'marker-selected' : '';
                    const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin ${cls} ${sel}"><i>${m.type === 'obstacle'?'!':m.type==='facility'?'âœ“':'i'}</i></div>`, iconSize: [30, 42], iconAnchor: [15, 42] });
                    const mk = L.marker([m.lat, m.lng], { icon }).addTo(layers.current.markers);
                    mk.on('click', (e) => { L.DomEvent.stopPropagation(e); vibrate(); if(handlers.current.onMarkerClick) handlers.current.onMarkerClick(m.id); mapRef.current.panTo([m.lat, m.lng]); });
                });
            }, [markers, selectedMarkerId, visibleTypes, currentUserId]);

            // --- [æ ¸å¿ƒå‡çº§] åŠ¨æ€å…‰æ ‡é€»è¾‘ ---
            useEffect(() => {
                const el = document.getElementById('map-container');
                if(el) {
                    // ç§»é™¤æ—§ç±»å
                    el.classList.remove('map-crosshair', 'cursor-target');
                    
                    // å¦‚æœæ¿€æ´»äº†å·¥å…·
                    if (activeTool) {
                        // ä½¿ç”¨æ–°çš„ç²¾ç¡®æ ‡è®°æ ·å¼
                        el.classList.add('cursor-target');
                    }
                }
            }, [activeTool]);

            return <div id="map-container"></div>;
        });

        // ----------------------------------------------------------------------------
        // 7. App Logic
        // ----------------------------------------------------------------------------
        const App = () => {
            const [markers, setMarkers] = useState([]);
            const [activeTool, setActiveTool] = useState(null);
            const [selectedMarkerId, setSelectedMarkerId] = useState(null);
            const [showSidebar, setShowSidebar] = useState(window.innerWidth > 768); 
            const [sidebarTab, setSidebarTab] = useState('main'); // main, manage
            const [showStats, setShowStats] = useState(false);
            const [showFABMenu, setShowFABMenu] = useState(false);
            const [toastMsg, setToastMsg] = useState(null);
            const [isHighContrast, setIsHighContrast] = useState(false);
            const [activeBaseLayer, setActiveBaseLayer] = useState('standard');
            const [visibleTypes, setVisibleTypes] = useState({ obstacle: true, facility: true, experience: true });
            const [activeElementFilters, setActiveElementFilters] = useState(null); 
            const [searchQuery, setSearchQuery] = useState('');
            const [customLocations, setCustomLocations] = useState(INITIAL_LOCATIONS);
            const [currentLocationName, setCurrentLocationName] = useState(INITIAL_LOCATIONS[0].name);
            const [drawingPoints, setDrawingPoints] = useState([]); 
            const [currentRoutePoints, setCurrentRoutePoints] = useState([]);
            const [customRoutes, setCustomRoutes] = useState([]);
            const mapInstanceRef = useRef(null);
            const markerImageInputRef = useRef(null);
            const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
            const [isAiAnalyzing, setIsAiAnalyzing] = useState(false);
            const [userName, setUserName] = useState(''); // [Fix] Added userName state
            const [currentUserId, setCurrentUserId] = useState(''); // [Fix] Added currentUserId state
            const [userId] = useState(generateRandomName());

            const safeParse = (key, fb) => { try { const i = localStorage.getItem(key); return i ? JSON.parse(i) : fb; } catch(e){ return fb; } };
            
            useEffect(() => {
                let savedName = localStorage.getItem('user_nickname');
                let savedId = localStorage.getItem('user_id');
                if (!savedId) { savedId = 'uid_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('user_id', savedId); }
                if (!savedName) { savedName = generateRandomName(); localStorage.setItem('user_nickname', savedName); }
                setCurrentUserId(savedId);
                setUserName(savedName);

                setCustomLocations(safeParse('custom_locations', INITIAL_LOCATIONS));
                setCustomRoutes(safeParse('custom_routes', []));
                const savedMarkers = safeParse('offline_markers', []);
                setMarkers(savedMarkers);
                
                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                const handleResize = () => { if (window.innerWidth > 768 && !showSidebar) setShowSidebar(true); };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const showToast = (msg) => setToastMsg(msg);
            const toggleLayer = (type) => setVisibleTypes(p => ({...p, [type]: !p[type]}));
            const toggleElementFilter = (key) => { setActiveElementFilters(p => p === key ? null : key); setActiveBaseLayer(key==='buildings'?'satellite':key==='water'?'simple':'standard'); };
            
            const saveMarker = async (data) => {
                vibrate();
                const newM = { ...data, id: 'm_'+Date.now() };
                const updated = [...markers, newM];
                setMarkers(updated);
                localStorage.setItem('offline_markers', JSON.stringify(updated));
                showToast("æ ‡è®°å·²ä¿å­˜");
                return newM.id;
            };
            const updateLocalMarker = (id, up) => {
                const updated = markers.map(m => m.id === id ? { ...m, ...up } : m);
                setMarkers(updated);
                localStorage.setItem('offline_markers', JSON.stringify(updated));
            };
            const deleteLocalMarker = (id) => {
                if(!confirm("åˆ é™¤æ­¤æ ‡è®°ï¼Ÿ")) return;
                const updated = markers.filter(m => m.id !== id);
                setMarkers(updated);
                localStorage.setItem('offline_markers', JSON.stringify(updated));
                setSelectedMarkerId(null);
                showToast("å·²åˆ é™¤");
            };

            const handleMapClick = (latlng) => {
                if (activeTool === 'draw-region' || activeTool === 'draw-landscape') { setDrawingPoints(p => [...p, [latlng.lat, latlng.lng]]); vibrate(); return; }
                if (activeTool === 'draw-route') { setCurrentRoutePoints(p => [...p, [latlng.lat, latlng.lng]]); vibrate(); return; }
                if (!activeTool) { if (selectedMarkerId) setSelectedMarkerId(null); return; }
                
                saveMarker({
                    lat: latlng.lat, lng: latlng.lng, type: activeTool, description: '', author: userName, userId: currentUserId, timestamp: Date.now(),
                    category: activeTool==='obstacle'?'other':null, severity: 'medium', votes: 0, imageUrl: '', status: 'pending', rating: 0
                }).then(id => { setActiveTool(null); setSelectedMarkerId(id); });
            };

            const finishDrawingRegion = () => {
                if (drawingPoints.length < 3) { alert("è‡³å°‘3ä¸ªç‚¹"); return; }
                const name = prompt(activeTool === 'draw-landscape' ? "æ™¯è§‚åç§°:" : "åŒºåŸŸåç§°:", "æ–°åŒºåŸŸ");
                if (name) {
                    const newLocs = [...customLocations, { name, type: 'region', subtype: activeTool, points: drawingPoints, id: 'reg_'+Date.now() }];
                    setCustomLocations(newLocs);
                    localStorage.setItem('custom_locations', JSON.stringify(newLocs));
                    showToast("åŒºåŸŸå·²ä¿å­˜");
                }
                setDrawingPoints([]); setActiveTool(null);
            };
            const finishDrawingRoute = (type) => {
                if (currentRoutePoints.length < 2) { alert("è‡³å°‘2ä¸ªç‚¹"); return; }
                const newRoutes = [...customRoutes, { points: currentRoutePoints, type, timestamp: Date.now() }];
                setCustomRoutes(newRoutes);
                localStorage.setItem('custom_routes', JSON.stringify(newRoutes));
                setCurrentRoutePoints([]); setActiveTool(null);
                showToast("è·¯çº¿å·²ä¿å­˜");
            };

            const deleteRoute = (ts) => {
                if(confirm("åˆ é™¤è¿™æ¡è·¯çº¿ï¼Ÿ")) {
                    const updated = customRoutes.filter(r => r.timestamp !== ts);
                    setCustomRoutes(updated);
                    localStorage.setItem('custom_routes', JSON.stringify(updated));
                    showToast("è·¯çº¿å·²åˆ é™¤");
                }
            };
            const deleteLocation = (loc) => {
                if(confirm(`åˆ é™¤ "${loc.name}"ï¼Ÿ`)) {
                    const updated = customLocations.filter(l => l !== loc);
                    setCustomLocations(updated);
                    localStorage.setItem('custom_locations', JSON.stringify(updated));
                    showToast("å·²åˆ é™¤");
                }
            };

            const handleMarkerImageUpload = (e, id) => {
                const file = e.target.files[0];
                if (file) {
                    const r = new FileReader();
                    r.onload = (ev) => updateLocalMarker(id, { imageUrl: ev.target.result });
                    r.readAsDataURL(file);
                }
            };

            const exportData = () => {
                const headers = ["ID", "Type", "Desc", "Coords", "AI", "Votes", "Author", "Time"];
                const rows = markers.map(m => [ m.id, m.type, `"${(m.description||'').replace(/"/g,'""')}"`, `${m.lat},${m.lng}`, `"${(m.aiResult||'').replace(/"/g,'""')}"`, m.votes||0, m.author, new Date(m.timestamp).toLocaleString() ]);
                const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `data_${Date.now()}.csv`; a.click();
            };

            const handleSaveSnapshot = () => {
                showToast("ç”Ÿæˆæˆªå›¾ä¸­...");
                const el = document.getElementById('map-container');
                document.querySelectorAll('.ui-layer').forEach(e => e.style.visibility = 'hidden');
                html2canvas(el, { useCORS: true, allowTaint: false, logging: false }).then(canvas => {
                    document.querySelectorAll('.ui-layer').forEach(e => e.style.visibility = 'visible');
                    const link = document.createElement('a'); link.download = `map_snapshot.png`; link.href = canvas.toDataURL(); link.click();
                }).catch(err => {
                    document.querySelectorAll('.ui-layer').forEach(e => e.style.visibility = 'visible');
                    alert("æˆªå›¾å¤±è´¥");
                });
            };

            const handleSearch = async () => {
                if (!searchQuery.trim()) return;
                showToast("æœç´¢ä¸­...");
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        mapInstanceRef.current.flyTo([data[0].lat, data[0].lon], 16);
                        setCurrentLocationName(data[0].display_name.split(',')[0]); 
                        if(window.innerWidth < 768) setShowSidebar(false);
                    } else { showToast("æ— ç»“æœ"); }
                } catch (e) { console.error(e); }
            };

            const handleLocateMe = () => {
                vibrate();
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.locate({setView: true, maxZoom: 18});
                    showToast("å®šä½ä¸­...");
                }
            };
            
            const analyzeMarker = async (marker) => {
                if (!GEMINI_API_KEY) { alert("éœ€é…ç½® API Key"); return; }
                if (!marker.imageUrl) { alert("éœ€ä¸Šä¼ å›¾ç‰‡"); return; }
                setIsAiAnalyzing(true); setAiAnalysisResult("åˆ†æä¸­...");
                try {
                    const res = await fetch(`${AI_ENDPOINT_URL}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "åˆ†ææ— éšœç¢è®¾æ–½é—®é¢˜" }, { inlineData: { mimeType: marker.imageUrl.split(';')[0].split(':')[1], data: marker.imageUrl.split(',')[1] } }] }] })
                    });
                    const result = await res.json();
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text || "æ— ç»“æœ";
                    setAiAnalysisResult(aiText);
                    updateLocalMarker(marker.id, { aiResult: aiText });
                } catch (error) { setAiAnalysisResult("åˆ†æå¤±è´¥"); } 
                finally { setIsAiAnalyzing(false); }
            };

            const startAddTool = (tool) => {
                vibrate();
                setActiveTool(tool);
                setShowFABMenu(false);
                if(window.innerWidth < 768) setShowSidebar(false);
                showToast(tool.startsWith('draw') ? "è¯·åœ¨åœ°å›¾ä¸Šç»˜ç‚¹" : "è¯·ç‚¹å‡»åœ°å›¾æ·»åŠ ");
            };

            const addCurrentViewToLocations = () => {
                if (mapInstanceRef.current) {
                    const center = mapInstanceRef.current.getCenter();
                    const name = prompt("è¯·è¾“å…¥å½“å‰ä½ç½®åç§°ï¼š", "æ–°ä½ç½®");
                    if (name) {
                        const newLocs = [...customLocations, { name, type: 'point', coords: [center.lat, center.lng], id: 'pt_'+Date.now() }];
                        setCustomLocations(newLocs);
                        localStorage.setItem('custom_locations', JSON.stringify(newLocs));
                        showToast("ä½ç½®å·²ä¿å­˜");
                    }
                }
            };

            const toggleVerification = (id) => {
                vibrate();
                const marker = markers.find(m => m.id === id);
                if (!marker) return;
                const newVotes = (marker.votes || 0) + 1;
                updateLocalMarker(id, { votes: newVotes });
                showToast("ğŸ‘ å·²ç‚¹èµéªŒè¯");
            };

            const renderDetailForm = () => {
                const m = markers.find(mk => mk.id === selectedMarkerId);
                if (!m) return null;
                const isMobile = window.innerWidth < 768;
                return (
                    <div className={`${isMobile ? `fixed bottom-0 left-0 right-0 rounded-t-2xl bottom-sheet ${m?'active':''}` : `absolute top-4 right-4 w-96 rounded-xl anim-scale-in`} bg-white z-[2000] shadow-2xl flex flex-col max-h-[85dvh] pointer-events-auto`}>
                        <div className={`p-4 text-white flex justify-between items-center ${m.status==='fixed'?'bg-slate-500':m.type==='obstacle'?'bg-red-500':m.type==='facility'?'bg-green-500':'bg-blue-500'} ${isMobile?'rounded-t-xl':'rounded-t-xl'}`}>
                            <span className="font-bold">è¯¦æƒ…ç¼–è¾‘</span>
                            <button onClick={()=>setSelectedMarkerId(null)}><Icons.X/></button>
                        </div>
                        <div className="p-5 space-y-4 overflow-y-auto flex-1 bg-slate-50">
                            <div className="bg-white p-3 rounded-xl border flex justify-between items-center">
                                <div className="text-xs text-slate-500"><Icons.User size={14}/> {m.author}</div>
                                <button onClick={()=>{updateLocalMarker(m.id, {votes:(m.votes||0)+1}); showToast("å·²ç‚¹èµ")}} className="text-blue-600 text-xs font-bold flex gap-1"><Icons.ThumbsUp size={14}/> é è°±({m.votes||0})</button>
                            </div>
                            <div className="space-y-1"><label className="block font-bold text-slate-700 ml-1">çŠ¶æ€</label><select value={m.status || 'pending'} onChange={e => updateLocalMarker(m.id, {status: e.target.value})} className="w-full border-2 border-slate-200 rounded-xl p-2.5 bg-white"><option value="pending">å¾…å¤„ç†</option><option value="in_progress">è¿›è¡Œä¸­</option><option value="fixed">å·²ä¿®å¤</option></select></div>
                            
                            {m.type === 'experience' && (
                                <div className="space-y-1">
                                    <label className="block font-bold text-slate-700 ml-1">ä½“éªŒè¯„åˆ†</label>
                                    <div className="flex gap-2">
                                        {[1,2,3,4,5].map(s => (
                                            <button key={s} onClick={()=>updateLocalMarker(m.id, {rating:s})} className={s<=(m.rating||0)?'text-yellow-500':'text-slate-300'}>
                                                <Icons.Star size={24} fill="currentColor"/>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {m.type === 'obstacle' && (
                                <div className="space-y-1"><label className="block font-bold text-slate-700 ml-1">ç±»å‹</label><div className="grid grid-cols-2 gap-2">{OBSTACLE_CATEGORIES.map(c => (<button key={c.value} onClick={() => updateLocalMarker(m.id, {category: c.value})} className={`text-xs py-2 px-2 rounded-lg border text-center transition-all ${m.category === c.value ? 'bg-red-50 border-red-500 text-red-700 font-bold' : 'bg-white border-slate-200 text-slate-600'}`}>{c.label}</button>))}</div></div>
                            )}
                            <div className="space-y-1"><label className="block font-bold text-slate-700 ml-1">æè¿°</label><SafeTextarea initialValue={m.description} onSave={v=>updateLocalMarker(m.id, {description:v})} placeholder="æè¿°æƒ…å†µ..."/></div>
                            <div className="space-y-1 border-t border-slate-200 pt-4">
                                <div className="flex justify-between items-center mb-2"><span className="font-bold text-slate-700 ml-1">ç…§ç‰‡</span><button onClick={() => markerImageInputRef.current.click()} className="text-blue-600 text-xs font-bold flex items-center gap-1 bg-blue-50 px-3 py-1.5 rounded-lg"><Icons.Upload size={14}/> ä¸Šä¼ </button><input type="file" ref={markerImageInputRef} onChange={e => handleMarkerImageUpload(e, m.id)} className="hidden" accept="image/*"/></div>
                                {m.imageUrl ? <div className="relative h-40 bg-slate-200 rounded-xl overflow-hidden group border border-slate-200"><img src={m.imageUrl} className="w-full h-full object-cover"/><button onClick={() => updateLocalMarker(m.id, {imageUrl: ''})} className="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1.5"><Icons.X size={14}/></button></div> : <div className="h-32 bg-white border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center text-slate-400" onClick={() => markerImageInputRef.current.click()}><Icons.Image size={32}/></div>}
                            </div>
                            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 space-y-3">
                                <button onClick={() => analyzeMarker(m)} disabled={isAiAnalyzing || !m.imageUrl} className={`w-full flex items-center justify-center gap-2 py-2.5 rounded-lg text-sm font-bold ${isAiAnalyzing ? 'bg-slate-200 text-slate-500' : 'bg-indigo-600 text-white'}`}>{isAiAnalyzing ? 'åˆ†æä¸­...' : <><Icons.Zap size={18}/> AI åˆ†æ</>}</button>
                                {(m.aiResult || aiAnalysisResult) && <div className="bg-white/80 p-3 rounded-lg border border-indigo-100 text-xs text-indigo-900 leading-relaxed backdrop-blur-sm">{safeRender(m.aiResult || aiAnalysisResult)}</div>}
                            </div>
                            <div className="flex justify-between pt-2"><button onClick={()=>deleteLocalMarker(m.id)} className="text-red-500 text-xs font-bold">åˆ é™¤</button><button onClick={()=>setSelectedMarkerId(null)} className="bg-slate-800 text-white px-4 py-1.5 rounded-lg text-xs font-bold">å®Œæˆ</button></div>
                        </div>
                    </div>
                );
            };

            const renderStatsModal = () => {
                if (!showStats) return null;
                const total = markers.length;
                const obstacleCount = markers.filter(m => m.type === 'obstacle').length;
                const facilityCount = markers.filter(m => m.type === 'facility').length;
                const healthScore = Math.max(0, Math.min(100, Math.round(60 + (facilityCount * 2) - (obstacleCount * 1.5))));
                const contributorMap = {};
                markers.forEach(m => { const name = m.author || 'åŒ¿å'; contributorMap[name] = (contributorMap[name] || 0) + 1; });
                const leaderboard = Object.entries(contributorMap).sort((a, b) => b[1] - a[1]).slice(0, 3);

                return (
                    <div className="fixed inset-0 z-[3000] bg-black/60 flex items-center justify-center p-4 pointer-events-auto backdrop-blur-sm anim-fade-in">
                        <div className="bg-white rounded-2xl w-full max-w-2xl p-6 relative flex flex-col max-h-[90dvh] shadow-2xl anim-scale-in overflow-hidden">
                            <button onClick={() => setShowStats(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700 bg-slate-100 p-1 rounded-full"><Icons.X size={20}/></button>
                            <div className="pb-4 border-b border-slate-100 mb-4"><h2 className="text-xl font-bold flex gap-2 items-center text-slate-800"><Icons.BarChart2 className="text-blue-600"/> æ•°æ®æ´å¯Ÿ</h2></div>
                            <div className="overflow-y-auto space-y-6 pr-2 flex-1 pb-4">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-2xl border border-blue-100 flex flex-col items-center justify-center relative overflow-hidden"><div className="text-xs text-blue-500 font-bold mb-1 uppercase">å¥åº·æŒ‡æ•°</div><div className="text-6xl font-black text-blue-600 z-10">{safeRender(healthScore)}</div><Icons.Activity size={100} className="absolute -bottom-4 -right-4 text-blue-100 opacity-50"/></div>
                                    <div className="bg-red-50 p-5 rounded-2xl border border-red-100 flex flex-col justify-between"><div><div className="text-xs font-bold text-red-500 uppercase">éšœç¢æ•°</div><div className="text-3xl font-black text-red-600 mt-1">{safeRender(obstacleCount)}</div></div><div className="bg-white p-2 rounded-full text-red-500 shadow-sm w-fit"><Icons.AlertTriangle size={20}/></div></div>
                                    <div className="bg-yellow-50 p-5 rounded-2xl border border-yellow-100 overflow-hidden relative"><div className="text-xs font-bold text-yellow-600 uppercase mb-3">å…‰è£æ¦œ</div><div className="space-y-2 relative z-10">{leaderboard.map((u, i) => (<div key={u[0]} className="flex justify-between text-xs bg-white/60 p-2 rounded-lg"><span className="font-bold text-slate-700">{safeRender(u[0])}</span><span className="font-bold text-yellow-700">{safeRender(u[1])}</span></div>))}</div></div>
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm"><h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><Icons.PieChart size={16}/> ç±»å‹åˆ†å¸ƒ</h3><div className="space-y-4">{OBSTACLE_CATEGORIES.map(cat => { const count = markers.filter(m => m.type === 'obstacle' && m.category === cat.value).length; if (count === 0) return null; return (<div key={cat.value}><div className="flex justify-between text-xs mb-1.5 font-medium text-slate-600"><span>{cat.label}</span><span>{count}</span></div><div className="w-full bg-slate-100 h-2 rounded-full"><div className="bg-blue-500 h-full rounded-full" style={{width: `${(count/obstacleCount)*100}%`}}></div></div></div>) })}</div></div>
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="bg-blue-50 p-4 rounded-xl text-center border border-blue-100"><div className="text-2xl font-bold text-blue-600">{total}</div><div className="text-xs text-blue-500 mt-1">æ€»æ ‡è®°</div></div>
                                    <div className="bg-green-50 p-4 rounded-xl text-center border border-green-100"><div className="text-2xl font-bold text-green-600">{facilityCount}</div><div className="text-xs text-green-500 mt-1">è®¾æ–½</div></div>
                                    <div className="bg-red-50 p-4 rounded-xl text-center border border-red-100"><div className="text-2xl font-bold text-red-600">{obstacleCount}</div><div className="text-xs text-red-500 mt-1">éšœç¢</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex h-full w-full bg-slate-50 text-slate-900 font-sans overflow-hidden relative select-none">
                    <MapView markers={markers} selectedMarkerId={selectedMarkerId} activeTool={activeTool} onMapClick={handleMapClick} onMarkerClick={setSelectedMarkerId} onMapReady={m=>mapInstanceRef.current=m} activeBaseLayer={activeBaseLayer} visibleTypes={visibleTypes} currentUserId={userId} customRegions={customLocations} drawingPoints={drawingPoints} currentRoutePoints={currentRoutePoints} customRoutes={customRoutes} activeElementFilters={activeElementFilters} onRouteClick={deleteRoute} onRegionClick={(reg)=>deleteLocation(reg)} />
                    
                    <div className="ui-layer">
                        <div className="scanning-bar"></div>
                        
                        {!showSidebar && <div className="absolute top-4 left-4 pointer-events-auto z-[1100] anim-scale-in"><button onClick={()=>{vibrate(); setShowSidebar(true);}} className="toggle-sidebar-btn bg-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center border-2 border-blue-500 text-blue-600 active:bg-blue-50"><Icons.Menu size={24}/></button></div>}
                        
                        {/* åº•éƒ¨æ  */}
                        <div className="absolute bottom-0 left-0 right-0 h-20 bg-white/95 backdrop-blur-md border-t border-slate-200 flex justify-between items-center px-6 z-[1100] pointer-events-auto shadow-2xl">
                             {/* å·¦ä¾§ï¼šå®šä½ */}
                            <button onClick={()=>{mapInstanceRef.current?.locate({setView:true, maxZoom:18}); showToast("å®šä½ä¸­...");}} className="p-3 rounded-full bg-blue-50 text-blue-600 shadow-sm hover:bg-blue-100 active:scale-95 transition"><Icons.Locate size={24}/></button>
                            
                            {/* ä¸­é—´ï¼šç»Ÿè®¡ */}
                            <button onClick={()=>setShowStats(true)} className="flex flex-col items-center gap-1 text-slate-500 hover:text-blue-600 active:scale-95 transition"><Icons.BarChart2 size={28}/><span className="text-[10px] font-bold">æ•°æ®ç»Ÿè®¡</span></button>
                            
                            {/* å³ä¾§ï¼šæ·»åŠ  (FAB) */}
                            <div className="relative">
                                {showFABMenu && <div className="absolute bottom-16 right-0 flex flex-col gap-3 items-end anim-scale-in origin-bottom-right w-40 pb-2">
                                    <button onClick={()=>{setActiveTool('experience'); setShowFABMenu(false); showToast("ç‚¹å‡»åœ°å›¾æ·»åŠ ");}} className="w-full fab-btn flex items-center justify-between bg-blue-500 text-white px-4 py-2.5 rounded-full shadow-lg"><span className="text-sm font-bold">ä½“éªŒç‚¹</span><Icons.Users/></button>
                                    <button onClick={()=>{setActiveTool('facility'); setShowFABMenu(false); showToast("ç‚¹å‡»åœ°å›¾æ·»åŠ ");}} className="w-full fab-btn flex items-center justify-between bg-green-500 text-white px-4 py-2.5 rounded-full shadow-lg"><span className="text-sm font-bold">è®¾æ–½ç‚¹</span><Icons.CheckCircle/></button>
                                    <button onClick={()=>{setActiveTool('obstacle'); setShowFABMenu(false); showToast("ç‚¹å‡»åœ°å›¾æ·»åŠ ");}} className="w-full fab-btn flex items-center justify-between bg-red-500 text-white px-4 py-2.5 rounded-full shadow-lg"><span className="text-sm font-bold">éšœç¢ç‚¹</span><Icons.AlertTriangle/></button>
                                </div>}
                                <button onClick={()=>{vibrate(); setShowFABMenu(!showFABMenu);}} className={`fab-btn w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transition-transform ${showFABMenu?'bg-slate-800 text-white rotate-45':'bg-blue-600 text-white'}`}><Icons.Plus size={32}/></button>
                            </div>
                        </div>

                        {activeTool && <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1100] flex items-center gap-3 bg-slate-900/90 backdrop-blur text-white px-5 py-2.5 rounded-full shadow-xl anim-slide-up pointer-events-auto border border-slate-700"><span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span><span className="text-sm font-bold">{activeTool.startsWith('draw') ? "ç»˜åˆ¶ä¸­..." : "æ·»åŠ æ ‡è®°ä¸­"}</span><button onClick={()=>setActiveTool(null)} className="ml-2 bg-white/20 rounded-full p-1"><Icons.X size={14}/></button></div>}

                        {(activeTool==='draw-region'||activeTool==='draw-route'||activeTool==='draw-landscape') && <div className="absolute bottom-24 left-1/2 transform -translate-x-1/2 z-[1100] pointer-events-auto"><button onClick={activeTool==='draw-route'?()=>finishDrawingRoute('safe'):finishDrawingRegion} className="fab-btn bg-green-600 text-white px-8 py-3 rounded-full shadow-xl font-bold text-lg">å®Œæˆç»˜åˆ¶</button></div>}

                        {renderDetailForm()}
                        <Toast message={toastMsg} onClose={()=>setToastMsg(null)}/>
                        {renderStatsModal()}

                        <div className={`sidebar-backdrop ${showSidebar ? 'active' : ''} md:hidden`} onClick={()=>setShowSidebar(false)}></div>
                        
                        <div className={`sidebar-panel absolute top-0 left-0 h-full bg-white/95 backdrop-blur-md border-r border-slate-200 flex flex-col shadow-2xl pointer-events-auto z-[2000] w-80 max-w-[85vw] transform ${showSidebar ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <div><h1 className="text-xl font-black flex gap-2 text-slate-800 items-center tracking-tight"><span className="text-blue-600"><Icons.Navigation size={24}/></span> å·å°æ¡¥ <span className="text-[10px] px-2 py-0.5 bg-yellow-500 text-white rounded-md font-bold tracking-wider">V22</span></h1><div className="mt-2 flex items-center gap-2 text-xs"><input value={userName} onChange={e => {setUserName(e.target.value); localStorage.setItem('user_nickname', e.target.value);}} className="border-b border-slate-300 w-20 bg-transparent outline-none font-bold text-slate-700" placeholder="æ˜µç§°"/><button onClick={() => setIsHighContrast(!isHighContrast)} className={`flex items-center gap-1 p-1 rounded ${isHighContrast ? 'text-blue-600 font-bold bg-blue-50' : 'text-slate-400'}`}><Icons.Moon size={12}/> {isHighContrast ? 'å…³' : 'æ¨¡å¼'}</button></div></div><button className="text-slate-400 hover:bg-slate-100 p-2 rounded-full" onClick={() => setShowSidebar(false)}><Icons.X size={20}/></button>
                            </div>
                            
                            {/* ä¾§è¾¹æ  Tabs */}
                            <div className="flex border-b border-slate-200 bg-white">
                                <button onClick={()=>setSidebarTab('main')} className={`flex-1 py-3 text-sm font-bold transition-colors ${sidebarTab==='main'?'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50':'text-slate-400 hover:text-slate-600'}`}>åŠŸèƒ½åœ°å›¾</button>
                                <button onClick={()=>setSidebarTab('manage')} className={`flex-1 py-3 text-sm font-bold transition-colors ${sidebarTab==='manage'?'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50':'text-slate-400 hover:text-slate-600'}`}>æ•°æ®ç®¡ç†</button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-8 pb-24">
                                {sidebarTab === 'main' ? (
                                    <>
                                        <section>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">è°ƒç ”ç‚¹ä½ç®¡ç†</h3>
                                            <div className="flex flex-wrap gap-2 mb-3">
                                                {customLocations.filter(l=>l.type!=='region').map(loc => (<button key={safeRender(loc.name)} onClick={() => {mapInstanceRef.current?.flyTo(loc.coords, 16); if(window.innerWidth<768) setShowSidebar(false);}} className="px-3 py-1.5 text-xs font-medium rounded-lg border border-slate-200 bg-white hover:border-blue-300 hover:text-blue-600 transition active:scale-95 flex items-center gap-1"><Icons.MapPin size={12}/>{safeRender(loc.name)}</button>))}
                                            </div>
                                            <div className="flex gap-2 mb-2">
                                                <button onClick={addCurrentViewToLocations} className="w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold border border-blue-100 hover:bg-blue-100">æ·»åŠ å½“å‰è§†è§’ä¸ºå¸¸ç”¨</button>
                                            </div>
                                            <div className="relative"><Icons.Search size={14} className="absolute left-3 top-3 text-slate-400"/><input className="w-full text-xs border border-slate-200 rounded-lg pl-9 pr-3 py-2.5 bg-slate-50 focus:border-blue-400 outline-none" placeholder="ç²¾ç¡®æœç´¢åœ°å›¾åœ°ç‚¹..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSearch()}/></div>
                                        </section>

                                        <section>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-1 tracking-wider"><Icons.Layers size={14}/> åœ°å›¾è¦ç´ </h3>
                                            <div className="grid grid-cols-4 gap-2 mb-4">
                                                {Object.keys(MAP_ELEMENTS).map(key => (
                                                    <button key={key} onClick={() => toggleElementFilter(key)} className={`flex flex-col items-center justify-center p-2 rounded-xl border text-[10px] transition-all ${activeElementFilters === key ? 'bg-indigo-50 border-indigo-500 text-indigo-700 font-bold ring-2 ring-indigo-100' : 'bg-white border-slate-100 text-slate-500 hover:border-slate-300'}`}>
                                                        <div className="mb-1">{React.createElement(Icons[MAP_ELEMENTS[key].icon], {size:18})}</div>{MAP_ELEMENTS[key].name.slice(0,2)}
                                                    </button>
                                                ))}
                                            </div>
                                        </section>

                                        <section>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">æ ‡è®°ç‚¹å›¾å±‚</h3>
                                            <div className="flex bg-slate-100 p-1 rounded-xl mb-4 border border-slate-200">{Object.keys(TILE_LAYERS).map(key => (<button key={key} onClick={() => setActiveBaseLayer(key)} className={`flex-1 py-1.5 text-xs rounded-lg font-bold transition-all ${activeBaseLayer === key ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400 hover:text-slate-600'}`}>{TILE_LAYERS[key].name}</button>))}</div>
                                            <div className="space-y-2">{[{ id: 'obstacle', label: 'éšœç¢ç‚¹', color: 'bg-red-500' }, { id: 'facility', label: 'è®¾æ–½ç‚¹', color: 'bg-green-500' }, { id: 'experience', label: 'ä½“éªŒç‚¹', color: 'bg-blue-500' }].map(item => (<div key={item.id} className="flex items-center justify-between p-2.5 border border-slate-100 rounded-xl bg-white hover:border-slate-300 transition cursor-pointer group" onClick={() => toggleLayer(item.id)}><div className="flex items-center gap-3"><span className={`w-2.5 h-2.5 rounded-full ${item.color} ring-2 ring-white shadow-sm`}></span><span className="text-xs font-bold text-slate-700">{item.label}</span></div><div className="text-slate-300">{visibleTypes[item.id] ? <Icons.Eye size={16}/> : <Icons.EyeOff size={16}/>}</div></div>))}</div>
                                        </section>

                                        <section>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">å·¥å…·ç®±</h3>
                                            <div className="grid grid-cols-3 gap-2">
                                                <button onClick={() => startAddTool('draw-route')} className="flex flex-col items-center justify-center gap-1 p-3 rounded-xl border border-dashed border-slate-300 bg-slate-50 hover:bg-white hover:border-blue-400 hover:text-blue-600 transition"><Icons.Route size={20}/><span className="text-[10px] font-bold">ç»˜åˆ¶è·¯çº¿</span></button>
                                                <button onClick={() => startAddTool('draw-region')} className="flex flex-col items-center justify-center gap-1 p-3 rounded-xl border border-dashed border-slate-300 bg-slate-50 hover:bg-white hover:border-blue-400 hover:text-blue-600 transition"><Icons.Square size={20}/><span className="text-[10px] font-bold">ç»˜åˆ¶åŒºåŸŸ</span></button>
                                                <button onClick={() => startAddTool('draw-landscape')} className="flex flex-col items-center justify-center gap-1 p-3 rounded-xl border border-dashed border-slate-300 bg-slate-50 hover:bg-white hover:border-blue-400 hover:text-blue-600 transition"><Icons.TreePine size={20}/><span className="text-[10px] font-bold">ç»˜åˆ¶æ™¯è§‚</span></button>
                                            </div>
                                        </section>
                                    </>
                                ) : (
                                    <>
                                        <section>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex justify-between items-center"><span>åŒºåŸŸä¸åœ°ç‚¹</span> <span className="bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-[10px]">{customLocations.length}</span></h3>
                                            <div className="space-y-2">
                                                {customLocations.map((loc, idx) => (
                                                    <div key={idx} className="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl shadow-sm">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`p-1.5 rounded-lg ${loc.type==='region'?'bg-blue-50 text-blue-500':'bg-green-50 text-green-500'}`}>{loc.type==='region'?<Icons.Square size={16}/>:<Icons.MapPin size={16}/>}</div>
                                                            <span className="text-xs font-bold text-slate-700">{safeRender(loc.name)}</span>
                                                        </div>
                                                        <button onClick={()=>deleteLocation(loc)} className="text-slate-300 hover:text-red-500 p-2"><Icons.Trash size={16}/></button>
                                                    </div>
                                                ))}
                                                {customLocations.length===0 && <div className="text-center text-xs text-slate-400 py-8 border-2 border-dashed border-slate-100 rounded-xl">æš‚æ— ä¿å­˜çš„åŒºåŸŸæˆ–åœ°ç‚¹</div>}
                                            </div>
                                        </section>
                                        <section>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex justify-between items-center"><span>ç»˜åˆ¶è·¯çº¿</span> <span className="bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-[10px]">{customRoutes.length}</span></h3>
                                            <div className="space-y-2">
                                                {customRoutes.map((r, idx) => (
                                                    <div key={idx} className="flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl shadow-sm">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`p-1.5 rounded-lg ${r.type==='safe'?'bg-green-50 text-green-500':'bg-red-50 text-red-500'}`}><Icons.Route size={16}/></div>
                                                            <div>
                                                                <div className="text-xs font-bold text-slate-700">{r.type==='safe'?'æ¨èè·¯çº¿':'å±é™©è·¯æ®µ'}</div>
                                                                <div className="text-[10px] text-slate-400">{new Date(r.timestamp).toLocaleDateString()}</div>
                                                            </div>
                                                        </div>
                                                        <button onClick={()=>deleteRoute(r.timestamp)} className="text-slate-300 hover:text-red-500 p-2"><Icons.Trash size={16}/></button>
                                                    </div>
                                                ))}
                                                {customRoutes.length===0 && <div className="text-center text-xs text-slate-400 py-8 border-2 border-dashed border-slate-100 rounded-xl">æš‚æ— ç»˜åˆ¶çš„è·¯çº¿</div>}
                                            </div>
                                        </section>
                                    </>
                                )}
                            </div>
                            <div className="p-4 border-t border-slate-200 bg-slate-50/80 backdrop-blur-sm"><div className="flex gap-3"><button onClick={()=>{setShowStats(true); if(window.innerWidth<768) setShowSidebar(false);}} className="flex-1 bg-white border border-slate-200 py-3 rounded-xl text-xs text-slate-600 active:bg-slate-100 flex flex-col items-center justify-center gap-1"><Icons.BarChart2 size={20} className="text-blue-500"/><span className="font-bold">ç»Ÿè®¡</span></button><button onClick={exportData} className="flex-1 bg-white border border-slate-200 py-3 rounded-xl text-xs text-slate-600 flex flex-col items-center justify-center gap-1"><Icons.Download size={20} className="text-green-500"/><span className="font-bold">æ•°æ®</span></button><button onClick={handleSaveSnapshot} className="flex-1 bg-slate-800 text-white py-3 rounded-xl text-xs active:bg-slate-900 flex flex-col items-center justify-center gap-1 shadow-lg"><Icons.Camera size={20}/><span className="font-bold">å­˜å›¾</span></button></div></div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>