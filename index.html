<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Â∑ùÂ∞èÊ°• | Êó†Ê≠¢ - ‰∏ì‰∏öÁöÑÊ†°Âõ≠Êó†ÈöúÁ¢çÁéØÂ¢ÉÁõëÊµã‰∏é‰∫íÂä©Âú∞Âõæ - V21.10 ÊóóËà∞‰∫§‰∫íÁâà">
    <meta name="theme-color" content="#3b82f6">
    <title>Â∑ùÂ∞èÊ°• | Êó†Ê≠¢ - ÊóóËà∞‰∫§‰∫íÁâà (V21.10)</title>
    
    <!-- ==================================================================================
         1. Ê†∏ÂøÉ‰æùËµñÂ∫ì (CDN)
         ================================================================================== -->
    
    <!-- Ê†∑ÂºèÂ∫ì: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Ê†∏ÂøÉÊ°ÜÊû∂: React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- ÁºñËØëÂô®: Babel (Áî®‰∫éËß£Êûê JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ÂêéÁ´ØÊúçÂä°: Firebase SDK (CompatÁâà) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Âú∞ÂõæÂºïÊìé: Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Â∑•ÂÖ∑Â∫ì: html2canvas (Êà™Âõæ) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- ==================================================================================
         2. ÂÖ®Â±ÄÊ†∑ÂºèÂÆö‰πâ (CSS)
         ================================================================================== -->
    <style>
        /* --- Âü∫Á°ÄÈáçÁΩÆ‰∏éÂ∏ÉÂ±Ä --- */
        body, html, #root { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            height: 100dvh; 
            width: 100%; 
            overflow: hidden; 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f8fafc;
            touch-action: manipulation; 
        }
        
        #map-container { 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            z-index: 0; 
            background: #e2e8f0; 
            transition: filter 0.3s ease;
        }
        
        .ui-layer { 
            position: absolute; 
            inset: 0; 
            z-index: 1000; 
            pointer-events: none; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }
        
        .pointer-events-auto { pointer-events: auto; }

        /* --- Âä®Áîª --- */
        @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes gauge { from { width: 0%; } }

        .anim-slide-left { animation: slideInLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .anim-scale-in { animation: scaleIn 0.2s ease-out; }
        .anim-slide-up { animation: slideInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .anim-fade-in { animation: fadeIn 0.2s ease-out; }
        .mic-active { animation: pulse-red 1.5s infinite; }
        .gauge-anim { animation: gauge 1s ease-out forwards; }

        /* --- ‰æßËæπÊ†è --- */
        .sidebar-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; backdrop-filter: blur(2px);
        }
        .sidebar-backdrop.active { opacity: 1; pointer-events: auto; }
        
        .sidebar-panel {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
        }
        
        .toggle-sidebar-btn {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toggle-sidebar-btn:active { transform: scale(0.9); }

        /* --- Â∫ïÈÉ®Èù¢Êùø --- */
        .bottom-sheet {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(105%);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-handle { width: 40px; height: 4px; background: #cbd5e1; border-radius: 2px; margin: 8px auto; }

        /* --- Ê†áËÆ∞Ê†∑Âºè --- */
        .custom-div-icon { background: transparent; border: none; }
        .marker-pin {
            width: 30px; height: 30px; border-radius: 50% 50% 50% 0; background: #3b82f6; position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3); border: 2px solid #FFFFFF; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .marker-pin i { transform: rotate(45deg); font-style: normal; color: white; font-weight: 800; font-size: 14px; line-height: 1; }
        .marker-obstacle { background: #ef4444; }
        .marker-facility { background: #22c55e; }
        .marker-experience { background: #3b82f6; }
        .marker-fixed { background: #64748b !important; border-color: #e2e8f0 !important; }
        .marker-others { opacity: 0.7; filter: grayscale(20%); transform: rotate(-45deg) scale(0.9) !important; }
        .marker-mine { z-index: 800 !important; border-color: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        .marker-selected { transform: rotate(-45deg) scale(1.4) !important; border-color: #fbbf24 !important; z-index: 999 !important; opacity: 1 !important; filter: none !important; box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.5); }
        .map-crosshair { cursor: crosshair !important; }
        
        .route-tooltip { background: rgba(255,255,255,0.95); border: 1px solid #cbd5e1; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-weight: bold; font-size: 12px; color: #334155; border-radius: 6px; padding: 4px 8px; }

        .scanning-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px; 
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            animation: scan 1.5s infinite; z-index: 5000; display: none;
        }
        .scanning .scanning-bar { display: block; }

        .high-contrast { filter: contrast(130%); }
        .high-contrast * { font-weight: 700 !important; letter-spacing: 0.02em; }
        .high-contrast .bg-white { background-color: #000 !important; color: #fff !important; border: 1px solid #fff !important; }
        .high-contrast .text-slate-600, .high-contrast .text-slate-500 { color: #e2e8f0 !important; }
        .high-contrast .bg-slate-50, .high-contrast .bg-slate-100 { background-color: #1e293b !important; color: #fff !important; }
        .high-contrast button { border: 2px solid #fff !important; }
        .high-contrast input, .high-contrast textarea, .high-contrast select { background: #333 !important; color: #fff !important; border: 2px solid #fff !important; }

        .fab-btn { transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .fab-btn:active { transform: scale(0.9); }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // ----------------------------------------------------------------------------
        // 1. Â∑•ÂÖ∑ÂáΩÊï∞
        // ----------------------------------------------------------------------------
        const safeRender = (val) => {
            if (val === null || val === undefined) return '';
            if (typeof val === 'object') {
                if (React.isValidElement(val)) return val;
                return ""; 
            }
            return String(val);
        };

        // ----------------------------------------------------------------------------
        // 2. ÈÖçÁΩÆ
        // ----------------------------------------------------------------------------
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCcBlaYfmLizo1E6mV87U6ytReqSuMTX5M",
  authDomain: "scuwzq-9bcfb.firebaseapp.com",
  projectId: "scuwzq-9bcfb",
  storageBucket: "scuwzq-9bcfb.firebasestorage.app",
  messagingSenderId: "1028374721634",
  appId: "1:1028374721634:web:30714cb0acb6a951590d3b" 
        };

        const GEMINI_API_KEY = ""; 
        const AI_ENDPOINT_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

        const TILE_LAYERS = {
            standard: { name: "Ê†áÂáÜÂú∞Âõæ", url: "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", attribution: '&copy; CARTO' },
            satellite: { name: "Âç´ÊòüÂΩ±ÂÉè", url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", attribution: '&copy; Esri' },
            simple: { name: "ÊûÅÁÆÄÊ®°Âºè", url: "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", attribution: '&copy; CARTO' }
        };

        const OBSTACLE_CATEGORIES = [
            { value: 'stairs', label: 'üöß Âè∞Èò∂/È´òÂ∑Æ' },
            { value: 'slope', label: 'üìâ Âù°Â∫¶ËøáÈô°' },
            { value: 'surface', label: 'üï≥Ô∏è Ë∑ØÈù¢‰∏çÂπ≥/ÂùëÊ¥º' },
            { value: 'width', label: '‚ÜîÔ∏è ÈÄöÈÅìËøáÁ™Ñ' },
            { value: 'blocked', label: 'üö´ Áõ≤ÈÅìË¢´Âç†Áî®' },
            { value: 'other', label: '‚ùì ÂÖ∂‰ªñÈóÆÈ¢ò' },
        ];

        const MAP_ELEMENTS = {
            buildings: { name: "Âª∫Á≠ëËΩÆÂªì", layer: 'building', query: `way["building"]` },
            roads: { name: "ÈÅìË∑ØÁΩëÁªú", layer: 'road', query: `way["highway"]` },
            water: { name: "Ê∞¥Á≥ªÊπñÊ≥ä", layer: 'water', query: `relation["natural"="water"]; way["natural"="water"]` },
            plants: { name: "ÁªøÂú∞ÂÖ¨Âõ≠", layer: 'green', query: `way["leisure"="park"]; way["landuse"="grass"]` }
        };

        const INITIAL_LOCATIONS = [
            { name: "Ê±üÂÆâÊ†°Âå∫", coords: [30.556, 103.998], type: 'point' },
            { name: "ÊúõÊ±üÊ†°Âå∫", coords: [30.631, 104.085], type: 'point' },
            { name: "ÂçéË•øÊ†°Âå∫", coords: [30.622, 104.068], type: 'point' }
        ];

        // ----------------------------------------------------------------------------
        // 3. Firebase ÂàùÂßãÂåñ
        // ----------------------------------------------------------------------------
        let db = null;
        let auth = null;
        let isOfflineMode = true;

        if (FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.apiKey.length > 5) {
            try {
                if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                db.enablePersistence().catch(err => console.warn('Persistence disabled'));
                isOfflineMode = false;
            } catch (e) { console.error("Firebase Init Error:", e); }
        }

        // ----------------------------------------------------------------------------
        // 4. ÂõæÊ†á
        // ----------------------------------------------------------------------------
        const Icons = {
            Menu: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            X: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Navigation: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Search: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Target: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Plus: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            AlertTriangle: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            CheckCircle: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Users: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Mic: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Camera: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            Upload: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Image: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Zap: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            ThumbsUp: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>,
            Route: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="6" cy="19" r="3"></circle><path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15"></path><circle cx="18" cy="5" r="3"></circle></svg>,
            Square: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>,
            Layers: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            Eye: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
            Moon: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Activity: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            BarChart2: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
            Download: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Trophy: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 21h8m-4-9v9m-6.7-6.27a4 4 0 1 1 0-7.73h13.4a4 4 0 1 1 0 7.73z"/></svg>,
            PieChart: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            User: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            MapPin: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            Building: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="5" width="18" height="16" rx="2"/><line x1="6" y1="17" x2="6" y2="10"/><line x1="10" y1="17" x2="10" y2="10"/><line x1="14" y1="17" x2="14" y2="10"/><line x1="18" y1="17" x2="18" y2="10"/></svg>,
            Droplet: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66c1.15 1.15 1.15 3.02 0 4.17l-5.66 5.66c-1.15 1.15-3.02 1.15-4.17 0l-5.66-5.66c-1.15-1.15-1.15-3.02 0-4.17l5.66-5.66z"/></svg>,
            TreePine: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7.74 15.68L2 21h20l-5.74-5.32c-1.15-1.15-3.02-1.15-4.17 0z"/><path d="M12 2v10m-3.5 3l3.5-3.5 3.5 3.5"/></svg>,
            Road: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 21l8-17H3m14 0l-8 17h16"/></svg>,
            Minimize: ({size=24, className}) => <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>
        };

        // ----------------------------------------------------------------------------
        // 5. Â∑•ÂÖ∑ÁªÑ‰ª∂
        // ----------------------------------------------------------------------------
        const vibrate = (pattern = 50) => {
            if (navigator.vibrate) navigator.vibrate(pattern);
        };

        const generateRandomName = () => {
            const adjs = ['ÁÉ≠ÂøÉ', 'Á•ûÁßò', 'Âø´‰πê', 'Âã§Âä≥', '‰∏ì‰∏ö', 'Èó™Áîµ', 'Êô∫ÊÖß'];
            const nouns = ['Ë°åËÄÖ', 'ËßÇÂØüÂëò', 'ÊµãÁªòÂ∏à', 'Â∞èÊ°•‰∫∫', 'ÂÆàÊä§ËÄÖ', 'ÂêëÂØº'];
            return adjs[Math.floor(Math.random()*adjs.length)] + nouns[Math.floor(Math.random()*nouns.length)] + '_' + Math.floor(Math.random()*1000);
        };

        const Toast = ({ message, onClose }) => {
            useEffect(() => {
                if (message) {
                    const timer = setTimeout(onClose, 3000);
                    return () => clearTimeout(timer);
                }
            }, [message]);

            if (!message) return null;
            return (
                <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-slate-800/90 text-white px-5 py-3 rounded-full text-sm font-bold shadow-xl z-[3000] flex items-center gap-2 anim-fade-in backdrop-blur-md border border-slate-700/50">
                    <span>{safeRender(message)}</span>
                </div>
            );
        };

        const SafeTextarea = ({ initialValue, onSave, placeholder }) => {
            const textareaRef = useRef(null);
            const timerRef = useRef(null);
            const [isListening, setIsListening] = useState(false);

            useEffect(() => {
                if (textareaRef.current) textareaRef.current.value = safeRender(initialValue);
            }, [initialValue]);

            const handleInput = (e) => {
                const val = e.target.value;
                if (timerRef.current) clearTimeout(timerRef.current);
                timerRef.current = setTimeout(() => { onSave(val); }, 800);
            };

            const toggleSpeech = () => {
                vibrate();
                if (!('webkitSpeechRecognition' in window)) {
                    alert("Êä±Ê≠âÔºåÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËæìÂÖ•ÔºåËØ∑Â∞ùËØï‰ΩøÁî® Chrome„ÄÇ");
                    return;
                }
                if (isListening) return;

                const recognition = new window.webkitSpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    const currentVal = textareaRef.current.value;
                    const newVal = (currentVal ? currentVal + ' ' : '') + text;
                    textareaRef.current.value = newVal;
                    onSave(newVal);
                };
                recognition.start();
            };

            return (
                <div className="relative group">
                    <textarea 
                        ref={textareaRef}
                        defaultValue={safeRender(initialValue)}
                        onInput={handleInput}
                        className="w-full border-2 border-slate-200 rounded-xl p-3 h-28 text-sm pr-10 focus:ring-2 focus:ring-blue-400 focus:outline-none focus:border-blue-400 transition-all resize-none bg-slate-50 focus:bg-white" 
                        placeholder={placeholder}
                    />
                    <button onClick={toggleSpeech} className={`absolute bottom-3 right-3 p-2 rounded-full transition-all shadow-sm ${isListening ? 'bg-red-500 text-white mic-active ring-2 ring-red-200' : 'bg-white text-slate-400 hover:text-blue-500 border border-slate-200'}`} title="ÁÇπÂáªÂºÄÂßãËØ≠Èü≥ËæìÂÖ•"><Icons.Mic size={18}/></button>
                </div>
            );
        };

        // ----------------------------------------------------------------------------
        // 6. MapView
        // ----------------------------------------------------------------------------
        const MapView = React.memo(({ 
            markers, selectedMarkerId, activeTool, onMapClick, onMarkerClick, onMapReady, 
            activeBaseLayer, visibleTypes, currentUserId, customRegions, drawingPoints, 
            currentRoutePoints, customRoutes, currentLocationName, onRouteClick, activeElementFilters 
        }) => {
            const mapRef = useRef(null);
            const markersLayerRef = useRef(null);
            const regionsLayerRef = useRef(null);
            const routesLayerRef = useRef(null);
            const drawingLayerRef = useRef(null);
            const tileLayerRef = useRef(null);
            const elementLayerRef = useRef(null);
            
            const handlers = useRef({ onMapClick, onMarkerClick, onRouteClick });
            useEffect(() => { handlers.current = { onMapClick, onMarkerClick, onRouteClick }; }, [onMapClick, onMarkerClick, onRouteClick]);

            useEffect(() => {
                if (!mapRef.current) {
                    const map = L.map('map-container', { center: INITIAL_LOCATIONS[0].coords, zoom: 16, zoomControl: false, tap: false });
                    
                    tileLayerRef.current = L.tileLayer(TILE_LAYERS[activeBaseLayer].url, { attribution: '', maxZoom: 20 }).addTo(map);
                    
                    elementLayerRef.current = L.layerGroup().addTo(map);
                    regionsLayerRef.current = L.layerGroup().addTo(map);
                    routesLayerRef.current = L.layerGroup().addTo(map);
                    drawingLayerRef.current = L.layerGroup().addTo(map);
                    markersLayerRef.current = L.layerGroup().addTo(map);
                    
                    mapRef.current = map;
                    if(onMapReady) onMapReady(map);
                    
                    map.on('click', (e) => { if(handlers.current.onMapClick) handlers.current.onMapClick(e.latlng); });
                }
            }, []);

            useEffect(() => {
                if (mapRef.current && tileLayerRef.current) {
                    mapRef.current.removeLayer(tileLayerRef.current);
                    tileLayerRef.current = L.tileLayer(TILE_LAYERS[activeBaseLayer].url, { attribution: '', maxZoom: 20 }).addTo(mapRef.current);
                }
            }, [activeBaseLayer]);

            useEffect(() => {
                if (!mapRef.current || !elementLayerRef.current) return;
                elementLayerRef.current.clearLayers();
                document.body.classList.remove('scanning');

                if (!activeElementFilters) return;

                const config = MAP_ELEMENTS[activeElementFilters];
                if (!config) return;
                if (mapRef.current.getZoom() < 14) return;
                
                document.body.classList.add('scanning');
                const bounds = mapRef.current.getBounds();
                const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
                const query = `[out:json][timeout:15];(${config.query}(${bbox}););out geom;`;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); 

                fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query, signal: controller.signal })
                    .then(res => res.json())
                    .then(data => {
                        if(data && data.elements) {
                            data.elements.forEach(el => {
                                let layer;
                                if (el.type === 'way' && el.geometry) {
                                    const latlngs = el.geometry.map(p => [p.lat, p.lon]);
                                    const style = { color: '#64748b', weight: 1, interactive: false };
                                    if (activeElementFilters === 'water') style.color = '#3b82f6';
                                    if (activeElementFilters === 'green') style.color = '#22c55e';
                                    layer = L.polyline(latlngs, style);
                                }
                                if (layer) layer.addTo(elementLayerRef.current);
                            });
                        }
                    })
                    .catch(e => console.log("Overpass Ignored", e))
                    .finally(() => { clearTimeout(timeoutId); document.body.classList.remove('scanning'); });
            }, [activeElementFilters]);

            useEffect(() => {
                if (!routesLayerRef.current) return;
                routesLayerRef.current.clearLayers();
                if (customRoutes) {
                    customRoutes.forEach(route => {
                        const color = route.type === 'safe' ? '#22c55e' : '#ef4444';
                        const polyline = L.polyline(route.points, { color: color, weight: 6, opacity: 0.8, lineCap: 'round', lineJoin: 'round', className: 'cursor-pointer' });
                        if(route.points.length > 1) {
                            L.circleMarker(route.points[0], {radius: 4, color: color, fillColor: '#fff', fillOpacity: 1}).addTo(routesLayerRef.current);
                            L.circleMarker(route.points[route.points.length-1], {radius: 4, color: color, fillColor: '#fff', fillOpacity: 1}).addTo(routesLayerRef.current);
                        }
                        polyline.bindTooltip(route.type === 'safe' ? "Êé®ËçêÊó†ÈöúÁ¢çË∑ØÁ∫ø" : "Â≠òÂú®È´òÂ∑Æ/Âç±Èô©Ë∑ØÊÆµ", { sticky: true, className: 'route-tooltip' });
                        polyline.on('click', (e) => { L.DomEvent.stopPropagation(e); vibrate(); if(handlers.current.onRouteClick) handlers.current.onRouteClick(route); });
                        polyline.addTo(routesLayerRef.current);
                    });
                }
            }, [customRoutes]);

            useEffect(() => {
                if (!drawingLayerRef.current) return;
                drawingLayerRef.current.clearLayers();
                if (drawingPoints.length > 0) {
                    L.polygon(drawingPoints, { color: '#3b82f6', weight: 2, dashArray: '5, 10', fillOpacity: 0.1 }).addTo(drawingLayerRef.current);
                    drawingPoints.forEach(pt => L.circleMarker(pt, { radius: 4, color: '#3b82f6', fillColor: '#fff', fillOpacity: 1 }).addTo(drawingLayerRef.current));
                }
                if (currentRoutePoints.length > 0) {
                     L.polyline(currentRoutePoints, { color: '#10b981', weight: 4, dashArray: '10, 10' }).addTo(drawingLayerRef.current);
                     currentRoutePoints.forEach(pt => L.circleMarker(pt, { radius: 3, color: '#10b981', fillColor: '#fff' }).addTo(drawingLayerRef.current));
                }
            }, [drawingPoints, currentRoutePoints]);

            useEffect(() => {
                if (!mapRef.current || !markersLayerRef.current) return;
                markersLayerRef.current.clearLayers();
                markers.forEach(m => {
                    if (!m.lat || !m.lng || !visibleTypes[m.type]) return;
                    let colorClass = m.status === 'fixed' ? 'marker-fixed' : (m.type === 'obstacle' ? 'marker-obstacle' : m.type === 'facility' ? 'marker-facility' : 'marker-experience');
                    const symbol = m.type === 'obstacle' ? '!' : m.type === 'facility' ? '‚úì' : 'i';
                    const ownershipClass = m.userId === currentUserId ? 'marker-mine' : 'marker-others';
                    const selectedClass = selectedMarkerId === m.id ? 'marker-selected' : '';
                    const html = `<div class="marker-pin ${colorClass} ${ownershipClass} ${selectedClass}"><i>${symbol}</i></div>`;
                    const icon = L.divIcon({ className: 'custom-div-icon', html, iconSize: [30, 42], iconAnchor: [15, 42] });
                    const marker = L.marker([m.lat, m.lng], { icon });
                    marker.on('click', (e) => { L.DomEvent.stopPropagation(e); vibrate(); if(handlers.current.onMarkerClick) handlers.current.onMarkerClick(m.id); mapRef.current.panTo([m.lat, m.lng]); });
                    marker.addTo(markersLayerRef.current);
                });
            }, [markers, selectedMarkerId, visibleTypes, currentUserId]);

            useEffect(() => {
                const el = document.getElementById('map-container');
                if(el) activeTool ? el.classList.add('map-crosshair') : el.classList.remove('map-crosshair');
            }, [activeTool]);

            return <div id="map-container"></div>;
        });

        // ----------------------------------------------------------------------------
        // 7. App
        // ----------------------------------------------------------------------------
        const App = () => {
            const [markers, setMarkers] = useState([]);
            const [activeTool, setActiveTool] = useState(null);
            const [selectedMarkerId, setSelectedMarkerId] = useState(null);
            const [showSidebar, setShowSidebar] = useState(window.innerWidth > 768); 
            const [showStats, setShowStats] = useState(false);
            const [showFABMenu, setShowFABMenu] = useState(false);
            const [toastMsg, setToastMsg] = useState(null);
            const [isHighContrast, setIsHighContrast] = useState(false);
            const [isConnected, setIsConnected] = useState(false);
            const [userName, setUserName] = useState('');
            const [currentUserId, setCurrentUserId] = useState('');
            const [activeBaseLayer, setActiveBaseLayer] = useState('standard');
            const [visibleTypes, setVisibleTypes] = useState({ obstacle: true, facility: true, experience: true });
            const [activeElementFilters, setActiveElementFilters] = useState(null); 
            const [searchQuery, setSearchQuery] = useState('');
            const [customLocations, setCustomLocations] = useState(INITIAL_LOCATIONS);
            const [currentLocationName, setCurrentLocationName] = useState(INITIAL_LOCATIONS[0].name);
            const [drawingPoints, setDrawingPoints] = useState([]); 
            const [currentRoutePoints, setCurrentRoutePoints] = useState([]);
            const [customRoutes, setCustomRoutes] = useState([]);
            const mapInstanceRef = useRef(null);
            const markerImageInputRef = useRef(null);
            const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
            const [isAiAnalyzing, setIsAiAnalyzing] = useState(false);

            const safeParse = (key, fallback) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : fallback;
                } catch (e) { return fallback; }
            };

            // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÊ∑ªÂä† toggleLayer ÂáΩÊï∞ ---
            const toggleLayer = (type) => {
                setVisibleTypes(prev => ({...prev, [type]: !prev[type]}));
            };

            // --- Ê†∏ÂøÉ‰øÆÂ§çÔºöÊ∑ªÂä† toggleElementFilter ÂáΩÊï∞ ---
            const toggleElementFilter = (key) => {
                setActiveElementFilters(prev => (prev === key ? null : key));
                if (key === 'buildings') setActiveBaseLayer('satellite');
                else if (key === 'water') setActiveBaseLayer('simple');
                else setActiveBaseLayer('standard');
            };

            useEffect(() => {
                let savedName = localStorage.getItem('user_nickname');
                let savedId = localStorage.getItem('user_id');
                if (!savedId) { savedId = 'uid_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('user_id', savedId); }
                if (!savedName) { savedName = generateRandomName(); localStorage.setItem('user_nickname', savedName); }
                setCurrentUserId(savedId);
                setUserName(savedName);
                setCustomLocations(safeParse('custom_locations', INITIAL_LOCATIONS));
                setCustomRoutes(safeParse('custom_routes', []));
                const handleResize = () => { if (window.innerWidth > 768 && !showSidebar) setShowSidebar(true); };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                if (isHighContrast) document.body.classList.add('high-contrast');
                else document.body.classList.remove('high-contrast');
            }, [isHighContrast]);

            useEffect(() => {
                if (!isOfflineMode && auth) {
                    auth.signInAnonymously().catch(e => console.error("Auth Error", e));
                    auth.onAuthStateChanged(user => {
                        setIsConnected(!!user);
                        if (user) {
                            const unsubscribe = db.collection('markers').onSnapshot(snap => {
                                const loaded = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(m => m.lat && m.lng); 
                                setMarkers(loaded);
                            }, err => console.error("Snapshot Error", err));
                            return () => unsubscribe();
                        }
                    });
                } else {
                    const saved = safeParse('offline_markers', []);
                    setMarkers(saved.filter(m => m.lat && m.lng));
                }
            }, []);

            const showToast = useCallback((msg) => setToastMsg(msg), []);

            const saveMarker = async (data) => {
                vibrate();
                const cleanData = JSON.parse(JSON.stringify(data));
                const tempId = 'temp_' + Date.now();
                setMarkers(prev => [...prev, { ...cleanData, id: tempId }]);
                showToast("üìç Ê†áËÆ∞Â∑≤ÊîæÁΩÆ");
                if (!isOfflineMode && db && isConnected) {
                    try { 
                        const ref = await db.collection('markers').add(cleanData); 
                        setMarkers(prev => prev.map(m => m.id === tempId ? { ...m, id: ref.id } : m));
                        if (selectedMarkerId === tempId) setSelectedMarkerId(ref.id);
                        return ref.id; 
                    } catch (e) { console.error("Save Error", e); return null; }
                } else {
                    const newId = 'local_' + Date.now();
                    const newMarker = { ...cleanData, id: newId };
                    setMarkers(prev => prev.map(m => m.id === tempId ? newMarker : m));
                    const currentSaved = safeParse('offline_markers', []);
                    localStorage.setItem('offline_markers', JSON.stringify([...currentSaved, newMarker]));
                    return newId;
                }
            };

            const updateLocalMarker = async (id, updates) => {
                setMarkers(prev => prev.map(m => m.id === id ? { ...m, ...updates } : m));
                if (!isOfflineMode && db && isConnected && !id.startsWith('local_')) {
                     db.collection('markers').doc(id).update(updates).catch(e => console.error(e));
                } else {
                    setTimeout(() => {
                        const currentMarkers = safeParse('offline_markers', []);
                        const newMarkers = currentMarkers.map(m => m.id === id ? { ...m, ...updates } : m);
                        localStorage.setItem('offline_markers', JSON.stringify(newMarkers));
                    }, 0);
                }
                if(updates.description || updates.votes) showToast("üíæ Â∑≤‰øùÂ≠ò");
            };

            const deleteLocalMarker = async (id) => {
                 if (!confirm("Á°ÆÂÆöÂà†Èô§Ôºü")) return;
                 setMarkers(prev => prev.filter(m => m.id !== id));
                 setSelectedMarkerId(null);
                 showToast("üóëÔ∏è Â∑≤Âà†Èô§");
                 if (!isOfflineMode && db && isConnected && !id.startsWith('local_')) {
                     db.collection('markers').doc(id).delete();
                } else {
                    const currentSaved = safeParse('offline_markers', []);
                    localStorage.setItem('offline_markers', JSON.stringify(currentSaved.filter(m => m.id !== id)));
                }
            };

            const toggleVerification = (id) => {
                vibrate();
                const marker = markers.find(m => m.id === id);
                if (!marker) return;
                const newVotes = (marker.votes || 0) + 1;
                updateLocalMarker(id, { votes: newVotes });
                showToast("üëç Â∑≤ÁÇπËµûÈ™åËØÅ");
            };

            const handleMapClick = async (latlng) => {
                if (activeTool === 'draw-region') { 
                    setDrawingPoints(prev => [...prev, [latlng.lat, latlng.lng]]); vibrate(); return; 
                }
                if (activeTool === 'draw-route') { 
                    setCurrentRoutePoints(prev => [...prev, [latlng.lat, latlng.lng]]); vibrate(); return; 
                }
                if (!activeTool) {
                    if (selectedMarkerId) setSelectedMarkerId(null); return; 
                }
                const { lat, lng } = latlng;
                const newData = { lat, lng, type: activeTool, description: '', author: userName, userId: currentUserId, timestamp: Date.now(), category: activeTool === 'obstacle' ? 'other' : null, severity: activeTool === 'obstacle' ? 'medium' : null, votes: 0, imageUrl: '', status: 'pending', aiResult: null };
                const id = await saveMarker(newData);
                if (id) { setActiveTool(null); setSelectedMarkerId(id); }
            };

            const startAddTool = (tool) => {
                vibrate();
                setActiveTool(tool);
                setShowFABMenu(false);
                if(window.innerWidth < 768) setShowSidebar(false);
                showToast(tool.startsWith('draw') ? "ËØ∑Âú®Âú∞Âõæ‰∏äÁªòÁÇπ" : "ËØ∑ÁÇπÂáªÂú∞ÂõæÊ∑ªÂä†");
            };

            const handleMarkerImageUpload = (e, id) => {
                const file = e.target.files[0];
                if (file) {
                    const r = new FileReader();
                    r.onload = (ev) => updateLocalMarker(id, { imageUrl: ev.target.result });
                    r.readAsDataURL(file);
                }
            };

            const exportData = () => {
                const headers = ["ID", "Type", "Desc", "Coords", "AI", "Votes", "Author", "Time"];
                const rows = markers.map(m => [ m.id, m.type, `"${(m.description||'').replace(/"/g,'""')}"`, `${m.lat},${m.lng}`, `"${(m.aiResult||'').replace(/"/g,'""')}"`, m.votes||0, m.author, new Date(m.timestamp).toLocaleString() ]);
                const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `data_${Date.now()}.csv`; a.click();
            };

            const handleSaveSnapshot = () => {
                showToast("ÁîüÊàêÊà™Âõæ‰∏≠...");
                const el = document.getElementById('map-container');
                document.querySelectorAll('.ui-layer').forEach(e => e.style.visibility = 'hidden');
                html2canvas(el, { useCORS: true, allowTaint: false, logging: false }).then(canvas => {
                    document.querySelectorAll('.ui-layer').forEach(e => e.style.visibility = 'visible');
                    const link = document.createElement('a'); link.download = `map_snapshot.png`; link.href = canvas.toDataURL(); link.click();
                }).catch(err => {
                    document.querySelectorAll('.ui-layer').forEach(e => e.style.visibility = 'visible');
                    alert("Êà™ÂõæÂ§±Ë¥•");
                });
            };

            const handleSearch = async () => {
                if (!searchQuery.trim()) return;
                showToast("ÊêúÁ¥¢‰∏≠...");
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        mapInstanceRef.current.flyTo([data[0].lat, data[0].lon], 16);
                        setCurrentLocationName(data[0].display_name.split(',')[0]); 
                        if(window.innerWidth < 768) setShowSidebar(false);
                    } else { showToast("Êó†ÁªìÊûú"); }
                } catch (e) { console.error(e); }
            };

            const handleLocateMe = () => {
                vibrate();
                if (mapInstanceRef.current) {
                    mapInstanceRef.current.locate({setView: true, maxZoom: 18});
                    showToast("ÂÆö‰Ωç‰∏≠...");
                }
            };
            
            const analyzeMarker = async (marker) => {
                if (!GEMINI_API_KEY) { alert("ÈúÄÈÖçÁΩÆ API Key"); return; }
                if (!marker.imageUrl) { alert("ÈúÄ‰∏ä‰º†ÂõæÁâá"); return; }
                setIsAiAnalyzing(true);
                setAiAnalysisResult("ÂàÜÊûê‰∏≠...");
                try {
                    const res = await fetch(`${AI_ENDPOINT_URL}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "ÂàÜÊûêÊó†ÈöúÁ¢çËÆæÊñΩÈóÆÈ¢ò" }, { inlineData: { mimeType: marker.imageUrl.split(';')[0].split(':')[1], data: marker.imageUrl.split(',')[1] } }] }] })
                    });
                    const result = await res.json();
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Êó†ÁªìÊûú";
                    setAiAnalysisResult(aiText);
                    updateLocalMarker(marker.id, { aiResult: aiText });
                } catch (error) { setAiAnalysisResult("ÂàÜÊûêÂ§±Ë¥•"); } 
                finally { setIsAiAnalyzing(false); }
            };

            const renderStatusPill = () => {
                if (!activeTool) return null;
                const texts = { obstacle: 'Ê∑ªÂä†ÈöúÁ¢çÁÇπ', facility: 'Ê∑ªÂä†ËÆæÊñΩÁÇπ', experience: 'Ê∑ªÂä†‰ΩìÈ™åÁÇπ', 'draw-route': 'ÁªòÂà∂Ë∑ØÁ∫ø', 'draw-region': 'ÁªòÂà∂Âå∫Âüü' };
                return (
                    <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1100] flex items-center gap-3 bg-slate-900/90 backdrop-blur text-white px-5 py-2.5 rounded-full shadow-xl anim-slide-up pointer-events-auto border border-slate-700">
                        <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                        <span className="text-sm font-bold">{safeRender(texts[activeTool])}</span>
                        <button onClick={() => setActiveTool(null)} className="ml-2 bg-white/20 rounded-full p-1"><Icons.X size={14}/></button>
                    </div>
                );
            };

            const renderFAB = () => {
                if (activeTool) return null;
                return (
                    <div className="absolute bottom-8 right-5 flex flex-col items-end gap-4 z-[1100] pointer-events-auto">
                        <div className={`flex flex-col gap-3 items-end transition-all duration-300 origin-bottom-right ${showFABMenu ? 'opacity-100 scale-100 translate-y-0' : 'opacity-0 scale-50 translate-y-10 pointer-events-none'}`}>
                            <button onClick={() => startAddTool('experience')} className="fab-btn flex items-center gap-3 bg-blue-500 text-white px-4 py-2.5 rounded-full shadow-lg"><span className="text-sm font-bold">‰ΩìÈ™åÁÇπ</span><div className="bg-white/20 p-1 rounded-full"><Icons.Users size={18}/></div></button>
                            <button onClick={() => startAddTool('facility')} className="fab-btn flex items-center gap-3 bg-green-500 text-white px-4 py-2.5 rounded-full shadow-lg"><span className="text-sm font-bold">ËÆæÊñΩÁÇπ</span><div className="bg-white/20 p-1 rounded-full"><Icons.CheckCircle size={18}/></div></button>
                            <button onClick={() => startAddTool('obstacle')} className="fab-btn flex items-center gap-3 bg-red-500 text-white px-4 py-2.5 rounded-full shadow-lg"><span className="text-sm font-bold">ÈöúÁ¢çÁÇπ</span><div className="bg-white/20 p-1 rounded-full"><Icons.AlertTriangle size={18}/></div></button>
                        </div>
                        <button onClick={() => { vibrate(); setShowFABMenu(!showFABMenu); }} className={`fab-btn w-14 h-14 rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 ${showFABMenu ? 'bg-slate-800 text-white rotate-45' : 'bg-blue-600 text-white'}`}><Icons.Plus size={28}/></button>
                    </div>
                );
            };

            const renderDetailForm = () => {
                const m = markers.find(mk => mk.id === selectedMarkerId);
                const isMobile = window.innerWidth < 768;
                const containerClass = isMobile ? `fixed bottom-0 left-0 right-0 bg-white z-[2000] rounded-t-2xl bottom-sheet ${m ? 'active' : ''} max-h-[85dvh] flex flex-col` : `absolute top-4 right-4 w-96 bg-white rounded-xl shadow-2xl border border-slate-200 z-[2000] overflow-hidden flex flex-col max-h-[90vh] anim-scale-in ${m ? '' : 'hidden'}`;
                if (!m) return null;
                const headerColor = m.status === 'fixed' ? 'bg-slate-500' : (m.type === 'obstacle' ? 'bg-red-500' : (m.type === 'facility' ? 'bg-green-500' : 'bg-blue-500'));

                return (
                    <div className={`${containerClass} pointer-events-auto`}>
                        {isMobile && <div className="sheet-handle"></div>}
                        <div className={`p-4 text-white flex justify-between items-center shrink-0 ${isMobile ? 'rounded-t-xl' : ''} ${headerColor}`}>
                            <span className="font-bold text-lg">ËØ¶ÊÉÖÁºñËæë</span>
                            <button onClick={() => setSelectedMarkerId(null)}><Icons.X size={20}/></button>
                        </div>
                        <div className="p-5 space-y-5 overflow-y-auto text-sm flex-1 pb-10 bg-slate-50">
                            <div className="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                                <div className="flex items-center gap-2 text-slate-500"><Icons.User size={16}/> <span className="font-bold text-slate-700">{safeRender(m.userId === currentUserId ? 'Êàë' : m.author)}</span></div>
                                <button onClick={() => toggleVerification(m.id)} className="flex items-center gap-1.5 text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-bold"><Icons.ThumbsUp size={14}/> Èù†Ë∞± ({safeRender(m.votes || 0)})</button>
                            </div>
                            <div className="space-y-1"><label className="block font-bold text-slate-700 ml-1">Áä∂ÊÄÅ</label><select value={m.status || 'pending'} onChange={e => updateLocalMarker(m.id, {status: e.target.value})} className="w-full border-2 border-slate-200 rounded-xl p-2.5 bg-white"><option value="pending">ÂæÖÂ§ÑÁêÜ</option><option value="in_progress">ËøõË°å‰∏≠</option><option value="fixed">Â∑≤‰øÆÂ§ç</option></select></div>
                            {m.type === 'obstacle' && (
                                <div className="space-y-1"><label className="block font-bold text-slate-700 ml-1">Á±ªÂûã</label><div className="grid grid-cols-2 gap-2">{OBSTACLE_CATEGORIES.map(c => (<button key={c.value} onClick={() => updateLocalMarker(m.id, {category: c.value})} className={`text-xs py-2 px-2 rounded-lg border text-center transition-all ${m.category === c.value ? 'bg-red-50 border-red-500 text-red-700 font-bold' : 'bg-white border-slate-200 text-slate-600'}`}>{c.label}</button>))}</div></div>
                            )}
                            <div className="space-y-1"><label className="block font-bold text-slate-700 ml-1">ÊèèËø∞</label><SafeTextarea key={m.id} initialValue={m.description} onSave={(val) => updateLocalMarker(m.id, {description: val})} placeholder="ÊèèËø∞ÊÉÖÂÜµ..."/></div>
                            <div className="space-y-1 border-t border-slate-200 pt-4">
                                <div className="flex justify-between items-center mb-2"><span className="font-bold text-slate-700 ml-1">ÁÖßÁâá</span><button onClick={() => markerImageInputRef.current.click()} className="text-blue-600 text-xs font-bold flex items-center gap-1 bg-blue-50 px-3 py-1.5 rounded-lg"><Icons.Upload size={14}/> ‰∏ä‰º†</button><input type="file" ref={markerImageInputRef} onChange={e => handleMarkerImageUpload(e, m.id)} className="hidden" accept="image/*"/></div>
                                {m.imageUrl ? <div className="relative h-40 bg-slate-200 rounded-xl overflow-hidden group border border-slate-200"><img src={m.imageUrl} className="w-full h-full object-cover"/><button onClick={() => updateLocalMarker(m.id, {imageUrl: ''})} className="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1.5"><Icons.X size={14}/></button></div> : <div className="h-32 bg-white border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center text-slate-400" onClick={() => markerImageInputRef.current.click()}><Icons.Image size={32}/></div>}
                            </div>
                            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 space-y-3">
                                <button onClick={() => analyzeMarker(m)} disabled={isAiAnalyzing || !m.imageUrl} className={`w-full flex items-center justify-center gap-2 py-2.5 rounded-lg text-sm font-bold ${isAiAnalyzing ? 'bg-slate-200 text-slate-500' : 'bg-indigo-600 text-white'}`}>{isAiAnalyzing ? 'ÂàÜÊûê‰∏≠...' : <><Icons.Zap size={18}/> AI ÂàÜÊûê</>}</button>
                                {(m.aiResult || aiAnalysisResult) && <div className="bg-white/80 p-3 rounded-lg border border-indigo-100 text-xs text-indigo-900 leading-relaxed backdrop-blur-sm">{safeRender(m.aiResult || aiAnalysisResult)}</div>}
                            </div>
                            <div className="pt-4 flex justify-between items-center"><button onClick={() => deleteLocalMarker(m.id)} className="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg text-xs font-bold">Âà†Èô§</button><button onClick={() => {setSelectedMarkerId(null); showToast("Â∑≤ÂÆåÊàê");}} className="bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold">ÂÆåÊàê</button></div>
                        </div>
                    </div>
                );
            };

            const renderStatsModal = () => {
                if (!showStats) return null;
                const total = markers.length;
                const obstacleCount = markers.filter(m => m.type === 'obstacle').length;
                const facilityCount = markers.filter(m => m.type === 'facility').length;
                const healthScore = Math.max(0, Math.min(100, Math.round(60 + (facilityCount * 2) - (obstacleCount * 1.5))));
                const contributorMap = {};
                markers.forEach(m => { const name = m.author || 'ÂåøÂêç'; contributorMap[name] = (contributorMap[name] || 0) + 1; });
                const leaderboard = Object.entries(contributorMap).sort((a, b) => b[1] - a[1]).slice(0, 3);

                return (
                    <div className="fixed inset-0 z-[3000] bg-black/60 flex items-center justify-center p-4 pointer-events-auto backdrop-blur-sm anim-fade-in">
                        <div className="bg-white rounded-2xl w-full max-w-2xl p-6 relative flex flex-col max-h-[90dvh] shadow-2xl anim-scale-in overflow-hidden">
                            <button onClick={() => setShowStats(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-700 bg-slate-100 p-1 rounded-full"><Icons.X size={20}/></button>
                            <div className="pb-4 border-b border-slate-100 mb-4"><h2 className="text-xl font-bold flex gap-2 items-center text-slate-800"><Icons.BarChart2 className="text-blue-600"/> Êï∞ÊçÆÊ¥ûÂØü</h2></div>
                            <div className="overflow-y-auto space-y-6 pr-2 flex-1 pb-4">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-2xl border border-blue-100 flex flex-col items-center justify-center relative overflow-hidden"><div className="text-xs text-blue-500 font-bold mb-1 uppercase">ÂÅ•Â∫∑ÊåáÊï∞</div><div className="text-6xl font-black text-blue-600 z-10">{safeRender(healthScore)}</div><Icons.Activity size={100} className="absolute -bottom-4 -right-4 text-blue-100 opacity-50"/></div>
                                    <div className="bg-red-50 p-5 rounded-2xl border border-red-100 flex flex-col justify-between"><div><div className="text-xs font-bold text-red-500 uppercase">ÈöúÁ¢çÊï∞</div><div className="text-3xl font-black text-red-600 mt-1">{safeRender(obstacleCount)}</div></div><div className="bg-white p-2 rounded-full text-red-500 shadow-sm w-fit"><Icons.AlertTriangle size={20}/></div></div>
                                    <div className="bg-yellow-50 p-5 rounded-2xl border border-yellow-100 overflow-hidden relative"><div className="text-xs font-bold text-yellow-600 uppercase mb-3">ÂÖâËç£Ê¶ú</div><div className="space-y-2 relative z-10">{leaderboard.map((u, i) => (<div key={u[0]} className="flex justify-between text-xs bg-white/60 p-2 rounded-lg"><span className="font-bold text-slate-700">{safeRender(u[0])}</span><span className="font-bold text-yellow-700">{safeRender(u[1])}</span></div>))}</div></div>
                                </div>
                                <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm"><h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><Icons.PieChart size={16}/> Á±ªÂûãÂàÜÂ∏É</h3><div className="space-y-4">{OBSTACLE_CATEGORIES.map(cat => { const count = markers.filter(m => m.type === 'obstacle' && m.category === cat.value).length; if (count === 0) return null; return (<div key={cat.value}><div className="flex justify-between text-xs mb-1.5 font-medium text-slate-600"><span>{cat.label}</span><span>{count}</span></div><div className="w-full bg-slate-100 h-2 rounded-full"><div className="bg-blue-500 h-full rounded-full" style={{width: `${(count/obstacleCount)*100}%`}}></div></div></div>) })}</div></div>
                            </div>
                            <div className="p-4 border-t border-slate-200 bg-slate-50/80 backdrop-blur-sm"><div className="flex gap-3"><button onClick={()=>{setShowStats(true); if(window.innerWidth<768) setShowSidebar(false);}} className="flex-1 bg-white border border-slate-200 py-3 rounded-xl text-xs text-slate-600 flex flex-col items-center justify-center gap-1"><Icons.BarChart2 size={20} className="text-blue-500"/><span className="font-bold">ÁªüËÆ°</span></button><button onClick={exportData} className="flex-1 bg-white border py-3 rounded-xl text-xs text-slate-600 flex flex-col items-center justify-center gap-1"><Icons.Download size={20} className="text-green-500"/><span className="font-bold">Êï∞ÊçÆ</span></button><button onClick={handleSaveSnapshot} className="flex-1 bg-slate-800 text-white py-3 rounded-xl text-xs flex flex-col items-center justify-center gap-1"><Icons.Camera size={20}/><span className="font-bold">Â≠òÂõæ</span></button></div></div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex h-full w-full bg-slate-50 text-slate-900 font-sans overflow-hidden relative select-none">
                    <MapView markers={markers} selectedMarkerId={selectedMarkerId} activeTool={activeTool} onMapClick={handleMapClick} onMarkerClick={setSelectedMarkerId} onMapReady={(map) => mapInstanceRef.current = map} activeBaseLayer={activeBaseLayer} visibleTypes={visibleTypes} currentUserId={currentUserId} customRegions={customLocations} drawingPoints={drawingPoints} currentRoutePoints={currentRoutePoints} customRoutes={customRoutes} activeElementFilters={activeElementFilters} currentLocationName={currentLocationName} onRouteClick={(r) => {if(confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ë∑ØÁ∫øÂêóÔºü")) setCustomRoutes(prev => prev.filter(pr => pr !== r));}} />
                    
                    <div className="ui-layer">
                        <div className="scanning-bar"></div>
                        
                        {!showSidebar && (
                            <div className="absolute top-4 left-4 pointer-events-auto z-[1100] anim-scale-in">
                                <button 
                                    onClick={() => {vibrate(); setShowSidebar(true);}} 
                                    className="toggle-sidebar-btn bg-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center border-2 border-blue-500 text-blue-600 hover:bg-blue-50 active:bg-blue-100 transition-all"
                                    title="ÊâìÂºÄËèúÂçï"
                                >
                                    <Icons.Target size={24} />
                                </button>
                            </div>
                        )}

                        <div className="absolute bottom-8 left-4 pointer-events-auto z-[1100]">
                            <button onClick={handleLocateMe} className="bg-white p-3.5 rounded-full shadow-xl text-blue-600 border border-slate-100 active:bg-blue-50 transition active:scale-95 group">
                                <Icons.Target size={24} className="group-active:rotate-12 transition-transform"/>
                            </button>
                        </div>

                        {renderStatusPill()}
                        {renderFAB()}
                        {renderDetailForm()}
                        <Toast message={toastMsg} onClose={() => setToastMsg(null)}/>
                        {renderStatsModal()}

                        <div className={`sidebar-backdrop ${showSidebar ? 'active' : ''} md:hidden`} onClick={() => setShowSidebar(false)}></div>

                        <div className={`sidebar-panel absolute top-0 left-0 h-full bg-white/95 backdrop-blur-md border-r border-slate-200 flex flex-col shadow-2xl pointer-events-auto z-[1200] w-80 max-w-[85vw] transform ${showSidebar ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                <div>
                                    <h1 className="text-xl font-black flex gap-2 text-slate-800 items-center tracking-tight">
                                        <span className="text-blue-600"><Icons.Navigation size={24}/></span> Â∑ùÂ∞èÊ°•
                                        <span className="text-[10px] px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded-md font-bold tracking-wider">V21.10</span>
                                    </h1>
                                    <div className="mt-2 flex items-center gap-2 text-xs">
                                        <input value={userName} onChange={e => {setUserName(e.target.value); localStorage.setItem('user_nickname', e.target.value);}} className="border-b border-slate-300 w-20 bg-transparent outline-none font-bold text-slate-700 focus:border-blue-500 transition-colors" placeholder="ÊòµÁß∞"/>
                                        <div className="h-3 w-px bg-slate-300"></div>
                                        <button onClick={() => setIsHighContrast(!isHighContrast)} className={`flex items-center gap-1 p-1 rounded transition-colors ${isHighContrast ? 'text-blue-600 font-bold bg-blue-50' : 'text-slate-400 hover:text-slate-600'}`}>
                                            <Icons.Moon size={12}/> {isHighContrast ? 'ÂÖ≥' : 'Ê®°Âºè'}
                                        </button>
                                    </div>
                                </div>
                                <button className="text-slate-400 hover:text-slate-600 hover:bg-slate-100 p-2 rounded-full transition" onClick={() => setShowSidebar(false)} title="Êî∂Ëµ∑ËèúÂçï">
                                    <Icons.Minimize size={20}/>
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-8">
                                <section><h3 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">‰ΩçÁΩÆ</h3><div className="flex flex-wrap gap-2 mb-3">{customLocations.map(loc => (<button key={safeRender(loc.name)} onClick={() => {if(mapInstanceRef.current) mapInstanceRef.current.flyTo(loc.coords || loc.points[0], 16); setCurrentLocationName(loc.name); if(window.innerWidth<768) setShowSidebar(false);}} className="px-3 py-1.5 text-xs font-medium rounded-lg border border-slate-200 bg-white hover:border-blue-300 hover:text-blue-600 transition active:scale-95">{safeRender(loc.name)}</button>))}</div><div className="relative"><Icons.Search size={14} className="absolute left-3 top-3 text-slate-400"/><input className="w-full text-xs border border-slate-200 rounded-lg pl-9 pr-3 py-2.5 bg-slate-50 outline-none" placeholder="ÊêúÁ¥¢..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSearch()}/></div></section>
                                <section><h3 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">Ê†áËÆ∞</h3><div className="space-y-3"><button onClick={() => startAddTool('obstacle')} className="w-full flex gap-3 p-3.5 border rounded-xl bg-white hover:shadow-md transition-all group"><div className="text-white bg-red-500 p-2.5 rounded-lg group-hover:scale-110 transition-transform"><Icons.AlertTriangle size={20}/></div><div><div className="font-bold text-sm text-slate-800">ÈöúÁ¢çÁÇπ</div><div className="text-xs text-slate-500">Ê†áËÆ∞Âè∞Èò∂„ÄÅÈô°Âù°</div></div></button><button onClick={() => startAddTool('facility')} className="w-full flex gap-3 p-3.5 border rounded-xl bg-white hover:shadow-md transition-all group"><div className="text-white bg-green-500 p-2.5 rounded-lg group-hover:scale-110 transition-transform"><Icons.CheckCircle size={20}/></div><div><div className="font-bold text-sm text-slate-800">ËÆæÊñΩÁÇπ</div><div className="text-xs text-slate-500">Ê†áËÆ∞ÁîµÊ¢Ø„ÄÅÂéïÊâÄ</div></div></button><button onClick={() => startAddTool('experience')} className="w-full flex gap-3 p-3.5 border rounded-xl bg-white hover:shadow-md transition-all group"><div className="text-white bg-blue-500 p-2.5 rounded-lg group-hover:scale-110 transition-transform"><Icons.Users size={20}/></div><div><div className="font-bold text-sm text-slate-800">‰ΩìÈ™åÁÇπ</div><div className="text-xs text-slate-500">ÂàÜ‰∫´ÊÑüÂèó</div></div></button></div></section>
                                <section><h3 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">ÁªòÂõæ</h3><div className="grid grid-cols-2 gap-3"><button onClick={() => startAddTool('draw-route')} className="flex flex-col items-center justify-center gap-2 p-3 rounded-xl border border-dashed bg-slate-50 hover:bg-white transition"><Icons.Route size={20}/><span className="text-xs font-bold">Ë∑ØÁ∫ø</span></button><button onClick={() => startAddTool('draw-region')} className="flex flex-col items-center justify-center gap-2 p-3 rounded-xl border border-dashed bg-slate-50 hover:bg-white transition"><Icons.Square size={20}/><span className="text-xs font-bold">Âå∫Âüü</span></button></div></section>
                                
                                <section>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-1 tracking-wider"><Icons.Layers size={14}/> ÂõæÂ±ÇËÆæÁΩÆ</h3>
                                    <div className="flex bg-slate-100 p-1 rounded-lg mb-4">{Object.keys(TILE_LAYERS).map(key => (<button key={key} onClick={() => setActiveBaseLayer(key)} className={`flex-1 py-1.5 text-xs rounded-md font-bold ${activeBaseLayer === key ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400'}`}>{TILE_LAYERS[key].name}</button>))}</div>
                                    
                                    <div className="mb-4">
                                        <div className="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider">Âú∞ÂõæÈÄèËßÜ</div>
                                        <div className="grid grid-cols-4 gap-2">
                                            {Object.keys(MAP_ELEMENTS).map(key => (
                                                <button 
                                                    key={key} 
                                                    onClick={() => toggleElementFilter(key)} 
                                                    className={`flex flex-col items-center justify-center p-2 rounded-lg border text-[10px] transition-all ${activeElementFilters === key ? 'bg-indigo-50 border-indigo-500 text-indigo-700 font-bold' : 'bg-white border-slate-100 text-slate-500 hover:border-slate-300'}`}
                                                >
                                                    <div className="mb-1">{React.createElement(Icons[MAP_ELEMENTS[key].layer === 'building' ? 'Building' : MAP_ELEMENTS[key].layer === 'road' ? 'Road' : MAP_ELEMENTS[key].layer === 'water' ? 'Droplet' : 'TreePine'], {size:16})}</div>
                                                    {MAP_ELEMENTS[key].name.slice(0,2)}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="space-y-2">{[{ id: 'obstacle', label: 'ÈöúÁ¢çÁÇπ', color: 'bg-red-500' }, { id: 'facility', label: 'ËÆæÊñΩÁÇπ', color: 'bg-green-500' }, { id: 'experience', label: '‰ΩìÈ™åÁÇπ', color: 'bg-blue-500' }].map(item => (<div key={item.id} className="flex items-center justify-between p-2.5 border border-slate-100 rounded-lg bg-white hover:bg-slate-50 transition cursor-pointer" onClick={() => toggleLayer(item.id)}><div className="flex items-center gap-3"><span className={`w-2.5 h-2.5 rounded-full ${item.color} ring-2 ring-white shadow-sm`}></span><span className="text-xs font-bold text-slate-700">{item.label}</span></div><div className="text-slate-300">{visibleTypes[item.id] ? <Icons.Eye size={16}/> : <Icons.EyeOff size={16}/>}</div></div>))}</div>
                                </section>
                            </div>
                            <div className="p-4 border-t border-slate-200 bg-slate-50/80 backdrop-blur-sm"><div className="flex gap-3"><button onClick={()=>{setShowStats(true); if(window.innerWidth<768) setShowSidebar(false);}} className="flex-1 bg-white border border-slate-200 py-3 rounded-xl text-xs text-slate-600 flex flex-col items-center justify-center gap-1 hover:shadow-md transition"><Icons.BarChart2 size={20} className="text-blue-500"/><span className="font-bold">ÁªüËÆ°</span></button><button onClick={exportData} className="flex-1 bg-white border border-slate-200 py-3 rounded-xl text-xs text-slate-600 flex flex-col items-center justify-center gap-1 hover:shadow-md transition"><Icons.Download size={20} className="text-green-500"/><span className="font-bold">Êï∞ÊçÆ</span></button><button onClick={handleSaveSnapshot} className="flex-1 bg-slate-800 text-white py-3 rounded-xl text-xs flex flex-col items-center justify-center gap-1 hover:shadow-lg transition"><Icons.Camera size={20}/><span className="font-bold">Â≠òÂõæ</span></button></div></div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>